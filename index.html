<!DOCTYPE html>
<html >
<head>
  <meta charset="utf-8">
  
  <title>New World</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Steadfast some, don&apos;t try so hard, what you want, time will give yo  qqäº¤æµç¾¤ï¼š114803643ï¼ŒCSDNåšå®¢é“¾æ¥:http://blog.csdn.net/liangliang103377">
<meta property="og:type" content="website">
<meta property="og:title" content="New World">
<meta property="og:url" content="https://runningyoung.github.io/index.html">
<meta property="og:site_name" content="New World">
<meta property="og:description" content="Steadfast some, don&apos;t try so hard, what you want, time will give yo  qqäº¤æµç¾¤ï¼š114803643ï¼ŒCSDNåšå®¢é“¾æ¥:http://blog.csdn.net/liangliang103377">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="New World">
<meta name="twitter:description" content="Steadfast some, don&apos;t try so hard, what you want, time will give yo  qqäº¤æµç¾¤ï¼š114803643ï¼ŒCSDNåšå®¢é“¾æ¥:http://blog.csdn.net/liangliang103377">
  
    <link rel="alternative" href="/atom.xml" title="New World" type="application/atom+xml">
  
  
    <link rel="icon" href="https://runningyoung.github.io/favicon.png">
  
  
      <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  
  
  
      <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
      <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">
  
  <link rel="stylesheet" href="/css/style.css">
  
      <style> .article { opacity: 0;} </style>
  
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="https://runningyoung.github.io/apple-touch-icon.png">
  
    
    
  
  
    <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <script src="//cdn.bootcss.com/jquery/1.9.1/jquery.min.js"></script>
  <script>
      var yiliaConfig = {
          fancybox: true,
          animate: true,
          isHome: true,
          isPost: false,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false,
      }
  </script>

  
      <script>
          yiliaConfig.rootUrl = https://runningyoung.github.io;
      </script>
  

  

  
      <script>
          var _hmt = _hmt || [];
          (function() {
              var hm = document.createElement("script");
              hm.src = "//hm.baidu.com/hm.js?200c79969158a0fa1fe0632060fe4221";
              var s = document.getElementsByTagName("script")[0]; 
              s.parentNode.insertBefore(hm, s);
          })();
      </script>
  
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="https://runningyoung.github.io/img/avatar.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">RunningYoung</a></h1>
        </hgroup>

        
                


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>Menu</li>
                        <li>Tags</li>
                        
                        
                        <li>About Me</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="https://runningyoung.github.io/">ä¸»é¡µ</a></li>
                        
                            <li><a href="https://runningyoung.github.io/archives/">æ‰€æœ‰æ–‡ç« </a></li>
                        
                            <li><a href="https://runningyoung.github.io/tags/">æ ‡ç­¾äº‘</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <li id="Email"><a class="Email" target="_blank" href="/1033773876@qq.com" title="Email"></a></li>
                            
                                <li id="GitHub"><a class="GitHub" target="_blank" href="https://github.com/RunningYoung" title="GitHub"></a></li>
                            
                                <li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/BDD/" style="font-size: 10px;">BDD</a> <a href="/tags/Block/" style="font-size: 10px;">Block</a> <a href="/tags/ReactiveCocoa/" style="font-size: 10px;">ReactiveCocoa</a> <a href="/tags/dependency-injection/" style="font-size: 10px;">dependency injection</a> <a href="/tags/ios-9-æ–°æŠ€æœ¯/" style="font-size: 10px;">ios 9 æ–°æŠ€æœ¯</a> <a href="/tags/jenkins/" style="font-size: 20px;">jenkins</a> <a href="/tags/å·¥å…·ç±»/" style="font-size: 10px;">å·¥å…·ç±»</a> <a href="/tags/è¯»ä¹¦ç¬”è®°/" style="font-size: 10px;">è¯»ä¹¦ç¬”è®°</a>
                    </div>
                </section>
                
                
                

                
                
                <section class="switch-part switch-part3">
                
                    <div id="js-aboutme">ä¸“æ³¨äºiOSå¼€å‘</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="å›åˆ°ä¸»é¡µ">RunningYoung</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="https://runningyoung.github.io/img/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="å›åˆ°ä¸»é¡µ">RunningYoung</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">ä¸»é¡µ</a></li>
                
                    <li><a href="/archives/">æ‰€æœ‰æ–‡ç« </a></li>
                
                    <li><a href="/tags/">æ ‡ç­¾äº‘</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <li id="Email"><a class="Email" target="_blank" href="/1033773876@qq.com" title="Email"></a></li>
                            
                                <li id="GitHub"><a class="GitHub" target="_blank" href="https://github.com/RunningYoung" title="GitHub"></a></li>
                            
                                <li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
                            
                        </ul>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap">
  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/06/hello-world/" class="article-date">
      <time datetime="2016-04-06T06:49:14.000Z" itemprop="datePublished">2016-04-06</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/06/hello-world/">Hello World</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-2016-04-05-jenkins2" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/01/2016-04-05-jenkins2/" class="article-date">
      <time datetime="2016-04-01T03:40:13.000Z" itemprop="datePublished">2016-04-01</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/01/2016-04-05-jenkins2/">iOSæŒç»­é›†æˆï¼šjenkins+gitlab+è’²å…¬è‹±+é‚®ä»¶é€šçŸ¥(Part 2)</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="iOSæŒç»­é›†æˆï¼šjenkins-gitlab-è’²å…¬è‹±-é‚®ä»¶é€šçŸ¥-Part-2"><a href="#iOSæŒç»­é›†æˆï¼šjenkins-gitlab-è’²å…¬è‹±-é‚®ä»¶é€šçŸ¥-Part-2" class="headerlink" title="iOSæŒç»­é›†æˆï¼šjenkins+gitlab+è’²å…¬è‹±+é‚®ä»¶é€šçŸ¥(Part 2)"></a>iOSæŒç»­é›†æˆï¼šjenkins+gitlab+è’²å…¬è‹±+é‚®ä»¶é€šçŸ¥(Part 2)</h1><h2 id="Jenkins-ç³»ç»Ÿè®¾ç½®-å‰æœŸå‡†å¤‡"><a href="#Jenkins-ç³»ç»Ÿè®¾ç½®-å‰æœŸå‡†å¤‡" class="headerlink" title="Jenkins ç³»ç»Ÿè®¾ç½® å‰æœŸå‡†å¤‡"></a>Jenkins ç³»ç»Ÿè®¾ç½® å‰æœŸå‡†å¤‡</h2><h3 id="Jenkins-æ’ä»¶å®‰è£…"><a href="#Jenkins-æ’ä»¶å®‰è£…" class="headerlink" title="Jenkins æ’ä»¶å®‰è£…"></a>Jenkins æ’ä»¶å®‰è£…</h3><ul>
<li><p>å®‰è£…GitLabæ’ä»¶</p>
<pre><code>å› ä¸ºæˆ‘ä»¬é¡¹ç›®ç”¨çš„æ˜¯GitLabæ¥ç®¡ç†æºä»£ç ï¼Œjenkinsæœ¬èº«å¹¶æ²¡æœ‰è‡ªå¸¦GitLabæ’ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¾æ¬¡é€‰æ‹© ***ç³»ç»Ÿç®¡ç† -&gt; ç®¡ç†æ’ä»¶*** åœ¨&quot;***å¯é€‰æ’ä»¶***&quot;ä¸­é€‰æ‹©GitLab Plugin å’Œ Gitlab Hook Plugin è¿™ä¸¤é¡¹ï¼Œç„¶åå®‰è£…
</code></pre></li>
<li><p>å®‰è£…Xcodeæ’ä»¶<br>åŒå®‰è£…GitLabæ’ä»¶æ­¥éª¤ä¸€æ ·ï¼Œæˆ‘ä»¬ä¸€æ¬¡é€‰æ‹©  <strong><em>ç³»ç»Ÿç®¡ç† -&gt; ç®¡ç†æ’ä»¶</em></strong> åœ¨â€<strong><em>å¯é€‰æ’ä»¶</em></strong>â€œä¸­é€‰æ‹©Xcode integrationè¿™ä¸¤é¡¹ï¼Œç„¶åå®‰è£…</p>
</li>
<li><p>å®‰è£…ç­¾åè¯ä¹¦ç®¡ç†æ’ä»¶<br>   iOSæ‰“åŒ…å†…æµ‹ç‰ˆæ—¶ï¼Œéœ€è¦å‘å¸ƒè¯ä¹¦åŠç›¸å…³ç­¾åæ–‡ä»¶ï¼Œå› æ­¤è¿™ä¸¤ä¸ªæ’ä»¶å¯¹äºç®¡ç†iOSè¯ä¹¦éå¸¸æ–¹ä¾¿ã€‚è¿˜æ˜¯åœ¨<strong><em>ç³»ç»Ÿç®¡ç†-&gt;ç®¡ç†æ’ä»¶</em></strong>ï¼Œåœ¨â€œ<strong><em>å¯é€‰æ’ä»¶</em></strong>â€ä¸­é€‰ä¸­â€œCredentials Pluginâ€å’Œâ€œKeychains and Provisioning Profiles Managementâ€å®‰è£…ã€‚</p>
<ul>
<li><p>å®‰è£…FTPæ’ä»¶<br>æ­¤æ’ä»¶å¯ç”¨äºä¸Šä¼ FTPæœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥ä¸Šä¼ åˆ°å…¬å¸å†…ç½‘çš„FTPæœåŠ¡å™¨ä¸­ã€‚â€Publish over FTPâ€</p>
</li>
<li><p>å®‰è£…è„šæœ¬æ’ä»¶<br>è¿™ä¸ªæ’ä»¶ä¸»è¦ç”¨äºbuildåæ‰§è¡Œå…ˆå…³è„šæœ¬.â€Publish over FTPâ€</p>
</li>
</ul>
</li>
</ul>
<h3 id="jenkins-ç³»ç»Ÿé…ç½®"><a href="#jenkins-ç³»ç»Ÿé…ç½®" class="headerlink" title="jenkins ç³»ç»Ÿé…ç½®"></a>jenkins ç³»ç»Ÿé…ç½®</h3><h4 id="jenkins-å®‰å…¨è®¾ç½®ï¼šæ³¨å†Œï¼Œç™»å½•"><a href="#jenkins-å®‰å…¨è®¾ç½®ï¼šæ³¨å†Œï¼Œç™»å½•" class="headerlink" title="jenkins å®‰å…¨è®¾ç½®ï¼šæ³¨å†Œï¼Œç™»å½•"></a>jenkins å®‰å…¨è®¾ç½®ï¼šæ³¨å†Œï¼Œç™»å½•</h4><p> è¿›å…¥ <strong><em>ç³»ç»Ÿç®¡ç†-&gt;Configure Global Security</em></strong> é¦–æ¬¡è®¾ç½®å¦‚å›¾æ‰€ç¤ºï¼š</p>
<p> <img src="../images/jenkins/login1.png" alt="é¦–æ¬¡è®¾ç½®"></p>
<p> é¦–æ¬¡è®¾ç½®å®Œç‚¹å‡»ä¿å­˜ï¼Œç„¶åç‚¹å‡»æ³¨å†Œ-&gt;ç™»å½•è´¦å·ï¼Œåœ¨è¿›å…¥è¯¥ç•Œé¢è¿›è¡Œè´¦å·æƒé™è®¾ç½®ï¼Œå¦‚å›¾</p>
<p>  <img src="../images/jenkins/login2.png" alt="æƒé™è®¾ç½®"></p>
<h4 id="jenkins-ç³»ç»Ÿè®¾ç½®"><a href="#jenkins-ç³»ç»Ÿè®¾ç½®" class="headerlink" title="jenkins ç³»ç»Ÿè®¾ç½®"></a>jenkins ç³»ç»Ÿè®¾ç½®</h4><p>è¿›å…¥ <strong><em>ç³»ç»Ÿç®¡ç†-&gt;ç³»ç»Ÿè®¾ç½®</em></strong> ç•Œé¢ï¼š</p>
<ul>
<li><p>é¦–å…ˆè®¾ç½®ä¸€ä¸‹ jenkins å†…éƒ¨shell æ‰§è¡Œç¼–ç ï¼Œç›®çš„å½“åœ¨jenkinsæ‰§è¡Œshellå‘½ä»¤æ—¶ï¼Œæœ‰æ—¶å€™ä¼šæŠ¥ utf-8 ç¼–ç é”™è¯¯ã€‚ä¸»è¦æ˜¯pod installçš„æ—¶å€™æŠ¥é”™ã€‚</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[33mWARNING: CocoaPods requires your terminal to be using UTF-8 encoding.</span><br></pre></td></tr></table></figure>
<p>  è®¾ç½®å¦‚ä¸‹ï¼š</p>
<p>  <img src="../images/jenkins/lang.png" alt="ç¼–ç è®¾ç½®"></p>
</li>
<li><p>jenkins Location è®¾ç½®<br>ä¸»è¦è®¾ç½® jenkins å¤–éƒ¨è®¿é—®çš„URL å’Œ ç³»ç»Ÿç®¡ç†å‘˜çš„é‚®ç®±åœ°å€ã€‚ç”¨æ¥å‘é€ é”™è¯¯æŠ¥å‘Šçš„é‚®ç®±åœ°å€ï¼šå¦‚å›¾</p>
<p><img src="../images/jenkins/location.png" alt="urlè®¾ç½®"></p>
</li>
<li><p>ç³»ç»Ÿé”™è¯¯æŠ¥å‘Šçš„é‚®ç®±è®¾ç½®ï¼Œä¸Šé¢åªè®¾ç½®äº†é‚®ç®±å‘é€çš„åœ°å€ï¼ˆFromåœ°å€ï¼‰ï¼Œä¸‹é¢è®¾ç½®ï¼Œé‚®ç®±çš„æœåŠ¡å™¨ï¼Œåè®®ï¼Œé‚®ç®±ï¼Œå¯†ç ã€‚å¦‚å›¾</p>
<p>   <img src="../images/jenkins/email.png" alt="emailè®¾ç½®"></p>
</li>
</ul>
<h2 id="Jenkins-ä»»åŠ¡ï¼ˆJobsï¼‰æ­å»º"><a href="#Jenkins-ä»»åŠ¡ï¼ˆJobsï¼‰æ­å»º" class="headerlink" title="Jenkins ä»»åŠ¡ï¼ˆJobsï¼‰æ­å»º"></a>Jenkins ä»»åŠ¡ï¼ˆJobsï¼‰æ­å»º</h2><h3 id="æ–°å»ºä»»åŠ¡-job"><a href="#æ–°å»ºä»»åŠ¡-job" class="headerlink" title="æ–°å»ºä»»åŠ¡ job"></a>æ–°å»ºä»»åŠ¡ job</h3><p>  åœ¨Jenkinsä¸­ï¼Œæ‰€æœ‰çš„ä»»åŠ¡éƒ½æ˜¯ä»¥â€œitemâ€ä¸ºå•ä½çš„ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ–°å»ºä¸€ä¸ªiOSçš„é¡¹ç›®æ¥å¼€å§‹è‡ªåŠ¨åŒ–æ„å»ºã€‚ç‚¹å‡»â€œæ–°å»ºâ€ï¼Œè¾“å…¥itemçš„åç§°ï¼Œé€‰æ‹©â€œæ„å»ºä¸€ä¸ªè‡ªç”±é£æ ¼çš„è½¯ä»¶é¡¹ç›®â€ï¼Œç„¶åç‚¹å‡»â€œOKâ€ã€‚å¦‚å›¾ï¼š</p>
<p>  <img src="../images/jenkins/createjob1.png" alt="æ–°å»ºJobè®¾ç½®"></p>
<p> è®¾ç½®æ„å»ºä¿¡æ¯</p>
<p> <img src="../images/jenkins/name.png" alt="æ„å»ºä¿¡æ¯è®¾ç½®"></p>
<h3 id="æºç ç®¡ç†"><a href="#æºç ç®¡ç†" class="headerlink" title="æºç ç®¡ç†"></a>æºç ç®¡ç†</h3><p>è¿™é‡Œç”¨åˆ°çš„æ˜¯GitLabï¼Œå…ˆéœ€è¦é…ç½®SSHï¼Œæˆ‘ä»¬å¯ä»¥åœ¨Jenkinsçš„è¯ä¹¦ç®¡ç†ä¸­æ·»åŠ SSHã€‚åœ¨Jenkinsç®¡ç†é¡µé¢ï¼Œé€‰æ‹©â€œCredentialsâ€ï¼Œç„¶åé€‰æ‹©â€œGlobal credentials (unrestricted)â€ï¼Œç‚¹å‡»â€œAdd Credentialsâ€ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬å¡«å†™è‡ªå·±çš„SSHä¿¡æ¯ï¼Œç„¶åç‚¹å‡»â€œSaveâ€ï¼Œè¿™æ ·å°±æŠŠSSHæ·»åŠ åˆ°Jenkinsçš„å…¨å±€åŸŸä¸­å»äº†ã€‚<br>è¿™è¾¹éœ€è¦æ³¨æ„çš„æ˜¯å¦‚ä½•è·å–SSH keyï¼šè¿™ä¸ªé—®é¢˜éœ€è¦å‚è€ƒ gitLab ä¸Šé…ç½®SSH çš„æ–¹æ³•ã€‚</p>
<ol>
<li>æŸ¥çœ‹æ˜¯å¦å·²ç»æœ‰äº†sshå¯†é’¥ï¼šcd ~/.sshï¼Œå¦‚æœæ²¡æœ‰å¯†é’¥åˆ™ä¸ä¼šæœ‰æ­¤æ–‡ä»¶å¤¹ï¼Œæœ‰åˆ™å¤‡ä»½åˆ é™¤</li>
<li>ç”Ÿæˆå¯†é’¥ï¼š<code>$ ssh-keygen -t rsa -C â€œhaiyan.xu.vip@gmail.comâ€</code> ç”Ÿæˆè¿‡ç¨‹ä¸­å¿…é¡»è®¾ç½®ç§˜é’¥å¯†ç  å¦åˆ™jenkins è®¾ç½®ä¼šä¸æˆåŠŸã€‚æœ€åå¾—åˆ°ä¸¤ä¸ªæ–‡ä»¶ï¼šid_rsaå’Œid_rsa.pub</li>
<li>æ·»åŠ å¯†é’¥åˆ°SSH ï¼š<code>ssh-add æ–‡ä»¶å</code> éœ€è¦è¾“å…¥ç®¡ç†å¯†ç </li>
<li>åœ¨gitlab ä¸Šæ·»åŠ  ssh å¯†é’¥ï¼Œè¿™é‡Œæ·»åŠ çš„æ˜¯ â€œid_rsa.pubâ€é‡Œé¢çš„å…¬é’¥ã€‚</li>
<li>åœ¨jenkinsä¸Šé…ç½®å¯†é’¥åˆ°SSH ï¼Œè¿™é‡Œæ·»åŠ çš„æ˜¯id_rsaé‡Œé¢çš„ç§é’¥ã€‚å…·ä½“è®¾ç½®å¦‚å›¾æ‰€ç¤ºï¼š</li>
</ol>
<p><img src="../images/jenkins/ssh.png" alt=""></p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†å›åˆ°åˆšåˆšæ–°å»ºçš„ä»»åŠ¡ä¸­ï¼Œåœ¨æºç ç®¡ç†ä¸­ï¼Œé€‰æ‹©Gitï¼ŒæŒ‰ä¸‹å›¾å¡«å¥½ç›¸å…³ä¿¡æ¯ã€‚PSï¼šCredentialsä¸éœ€è¦é€‰æ‹©ã€‚å¦‚å›¾</p>
<p><img src="../images/jenkins/git.png" alt=""></p>
<h3 id="æ„å»ºè§¦å‘å™¨è®¾ç½®"><a href="#æ„å»ºè§¦å‘å™¨è®¾ç½®" class="headerlink" title="æ„å»ºè§¦å‘å™¨è®¾ç½®"></a>æ„å»ºè§¦å‘å™¨è®¾ç½®</h3><p>è¯¥è®¾ç½®ä¸»è¦æ˜¯ä¸ºäº†å®ç°è‡ªåŠ¨è§¦å‘ jenkins æ„å»ºè¿‡ç¨‹ çœŸæ­£å®ç°è‡ªåŠ¨åŒ–è®¾ç½®:<br>è¿™è¾¹ä¸»è¦å¤„ç†çš„æ˜¯ <strong><em>gitlab hook</em></strong> çš„è®¾ç½®ã€‚ä¸»è¦ç›®çš„æ˜¯å½“é¡¹ç›®ä¸­æœ‰äººgit push æäº¤è¿‡ä»£ç ä¹‹åï¼Œå°±ä¼šè‡ªåŠ¨çš„è§¦å‘ jenkins çš„æœ¬Jobçš„æ„å»ºï¼Œå®ç°è‡ªåŠ¨åŒ–æ‰“åŒ…ã€‚</p>
<ol>
<li>é¦–é€‰éœ€è¦åœ¨gitlab é¡¹ç›®ç®¡ç†å®˜ç½‘ä¸Šè®¾ç½® æ·»åŠ git hook çš„åœ°å€ï¼šå¦‚å›¾ï¼šè¯¥åœ°å€æ˜¯jenkins ä¸Š æç¤ºçš„åœ°å€ ä¸‹é¢ä¼šæåˆ°</li>
</ol>
<p><img src="../images/jenkins/gitlabhook.png" alt=""></p>
<ol>
<li>jenkins ä¸Šå¯¹ gitlab hook è¿›è¡Œç›¸å…³é…ç½® å¦‚å›¾æ‰€ç¤ºï¼š</li>
</ol>
<p><img src="../images/jenkins/jenkinsgitlabhook.png" alt=""></p>
<h3 id="æ„å»ºç¯å¢ƒ"><a href="#æ„å»ºç¯å¢ƒ" class="headerlink" title="æ„å»ºç¯å¢ƒ"></a>æ„å»ºç¯å¢ƒ</h3><p>åœ¨è¯¥æ¨¡å—ä¸­ ä¸»è¦è®¾ç½® xcode build æ‰“åŒ…æ—¶éœ€è¦çš„ keychains å’Œ Provision Profiles é…ç½®æ–‡ä»¶ã€‚<br>å¦‚æœä¸é…ç½® å°±ä¼šä½¿ç”¨ xcode è‡ªåŠ¨çš„é…ç½®ï¼Œæ¥å»ç³»ç»Ÿä¸­æŸ¥æ‰¾ç›¸åº”çš„é…ç½®ï¼Œä¸è¿‡æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„,å°±æ˜¯é’¥åŒ™ä¸²ä¸­ï¼Œç™»é™†é’¥åŒ™ä¸²ä¸­çš„è¯ä¹¦ è¦å¤åˆ¶åˆ° ç³»ç»Ÿé’¥åŒ™ä¸²ä¸­ï¼Œå› ä¸ºjenkins è®¿é—®çš„æ˜¯ç³»ç»Ÿä¸­çš„é’¥åŒ™ä¸² è¿™æ ·åœ¨ç¬¬ä¸€æ¬¡æ‰“åŒ…çš„æ—¶å€™ï¼Œä¼šæç¤º æ˜¯å¦æˆæƒè®¿é—®é’¥åŒ™ä¸²ï¼Œç‚¹å‡»å§‹ç»ˆå…è®¸å°±å¯ä»¥äº†ã€‚<br>æ³¨æ„ï¼šåœ¨ç”µè„‘ä¸Šå®‰è£…å¥½ xcode é…ç½®ç›¸å…³çš„è¯ä¹¦å’Œé…ç½®æ–‡ä»¶ï¼Œé…ç½®æ–‡ä»¶ä¹Ÿè¦å®‰è£…åˆ°ç³»ç»Ÿç›®å½•ä¸‹ã€‚<br>å…·ä½“æ“ä½œå¦‚ä¸‹ï¼šä»è¯¥ç”¨æˆ·ç›®å½•ä¸‹çš„æ‰€æœ‰æè¿°æ–‡ä»¶</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Users/ç”¨æˆ·å/Library/MobileDevice/Provisioning Profiles</span><br></pre></td></tr></table></figure>
<p>å¤åˆ¶åˆ°ç³»ç»Ÿç›®å½•ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Library/MobileDevice/Provisioning Profiles</span><br></pre></td></tr></table></figure>
<h3 id="æ„å»º"><a href="#æ„å»º" class="headerlink" title="æ„å»º"></a>æ„å»º</h3><p>è¯¥æ¨¡å—å¼€å§‹è®¾ç½® iOSæ‰“åŒ…ç›¸å…³çš„é…ç½®ã€‚</p>
<ol>
<li><p>ç‚¹å‡»å¢åŠ æ„å»ºæ­¥éª¤-&gt; Execute Shell .é¦–å…ˆ åœ¨build ä¹‹å‰éœ€è¦å…ˆ pod install ï¼Œå¹¶ä¸”æœ€ç†æƒ³çš„æƒ…å†µæ˜¯æ¯æ¬¡æ„å»ºçš„æ—¶å€™ buildå·éƒ½æ”¹å˜ã€‚å¦‚å›¾æ‰€ç¤º<br> éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨å…¨å±€å˜é‡æ—¶ å¿…é¡»æ‰¾åˆ°ç»å¯¹è·¯å¾„æ‰èƒ½è°ƒç”¨ç›¸å…³çš„å‘½ä»¤ï¼šç‰ˆæœ¬å·å¢åŠ <a href="https://www.5288z.com/?p=1651" target="_blank" rel="external">å‚è€ƒé“¾æ¥</a></p>
<p> <img src="../images/jenkins/pod.png" alt=""></p>
</li>
<li><p>ç‚¹å‡»å¢åŠ æ„å»ºæ­¥éª¤ xcode ï¼Œå…·ä½“é…ç½®å¦‚å›¾ï¼š<br>  è¯¥é…ç½®ä¸­éœ€è¦æ³¨æ„ åœ¨OS X 10.10.XXç‰ˆæœ¬ jenkins xcode æ’ä»¶ä¸æ”¯æŒ ç”Ÿæˆipaæ–‡ä»¶ï¼Œä½† OS X 10.11 æ”¯æŒ è¿™ä¸ªæ—¶å€™ éœ€è¦æ‰‹åŠ¨è¿›è¡Œæ‰“åŒ…ï¼Œå…·ä½“çš„å°±æ˜¯åœ¨build å®Œæˆä¹‹å æ·»åŠ EXecute Shell ï¼Œåˆ©ç”¨shellè„šæœ¬æ‰“åŒ…ï¼šä»£ç å¦‚ä¸‹ï¼š</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcrun -sdk iphones PackageApplication -v [å·¥ç¨‹ç›®å½•] -o [ipaè¾“å‡ºç›®å½•]/xx.ipa</span><br></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>![](../images/jenkins/xcode.png)
</code></pre><ol>
<li><p>Code signing &amp; OS X keychain options é…ç½®ï¼šå¦‚å›¾</p>
<p><img src="../images/jenkins/codesigning.png" alt=""></p>
</li>
<li><p>Advanced Xcode build options é…ç½®ï¼šå¦‚å›¾</p>
<p>  <img src="../images/jenkins/xcodebuild.png" alt=""></p>
</li>
</ol>
<h3 id="æ„å»ºåæ“ä½œ"><a href="#æ„å»ºåæ“ä½œ" class="headerlink" title="æ„å»ºåæ“ä½œ"></a>æ„å»ºåæ“ä½œ</h3><p> æ‰“åŒ…å®Œæˆä¹‹å éœ€è¦æ‰§è¡Œ ä¸Šä¼ åˆ°è’²å…¬è‹± å’Œ å‘é€é‚®ä»¶ é€šçŸ¥å¼€å‘äººå‘˜ã€‚<br>   å…·ä½“æ“ä½œæˆ‘ç”¨pythonå†™çš„è„šæœ¬æ¥å®Œæˆæ­¤åŠŸèƒ½ï¼šéœ€è¦çš„ç«¥é‹å¯ä»¥å»githubä¸Šä¸‹è½½ï¼šåœ¨æ–‡ç« æœ€åï¼ï¼<br>   å…·ä½“è°ƒç”¨å¦‚å›¾ï¼š</p>
<p><img src="../images/jenkins/pgy.png" alt=""></p>
<p>  æœ€åè®¾ç½® é€šçŸ¥é‚®ä»¶ E-mail Notification å¡«å†™æ¥å—é‚®ç®±å³å¯ æ¯æ¬¡æ„å»ºå¤±è´¥éƒ½ä¼šå‘ç”Ÿé‚®ä»¶é€šçŸ¥ï¼ï¼ï¼</p>
<p> <a href="https://github.com/RunningYoung/jenkins-pgy-python" target="_blank" rel="external">python è„šæœ¬åœ°å€</a>!!! ä¸è¦åå•¬ starï¼ï¼ï¼ä¸èƒœæ„Ÿæ¿€ï¼ï¼ï¼ </p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jenkins/">jenkins</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-2016-04-01-jenkins1" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/01/2016-04-01-jenkins1/" class="article-date">
      <time datetime="2016-04-01T01:25:16.000Z" itemprop="datePublished">2016-04-01</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/01/2016-04-01-jenkins1/">iOSæŒç»­é›†æˆï¼šjenkins+gitlab+è’²å…¬è‹±+é‚®ä»¶é€šçŸ¥(Part 1)</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="iOSæŒç»­é›†æˆï¼šjenkins-gitlab-è’²å…¬è‹±-é‚®ä»¶é€šçŸ¥-Part-1"><a href="#iOSæŒç»­é›†æˆï¼šjenkins-gitlab-è’²å…¬è‹±-é‚®ä»¶é€šçŸ¥-Part-1" class="headerlink" title="iOSæŒç»­é›†æˆï¼šjenkins+gitlab+è’²å…¬è‹±+é‚®ä»¶é€šçŸ¥(Part 1)"></a>iOSæŒç»­é›†æˆï¼šjenkins+gitlab+è’²å…¬è‹±+é‚®ä»¶é€šçŸ¥(Part 1)</h1><h2 id="jenkinsç¯å¢ƒæ­å»º"><a href="#jenkinsç¯å¢ƒæ­å»º" class="headerlink" title="jenkinsç¯å¢ƒæ­å»º"></a>jenkinsç¯å¢ƒæ­å»º</h2><p>åœ¨Macç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå®‰è£…JDKï¼Œç„¶ååœ¨jenkinsçš„<a href="https://jenkins.io/index.html" target="_blank" rel="external">å®˜ç½‘</a>ä¸‹è½½æœ€æ–°Mac OS Xç‰ˆæœ¬çš„dmgåŒ…ã€‚å®‰è£…å®ŒdmgåŒ…ä¹‹å é»˜ç„¶è‡ªåŠ¨å¼€å¯jenkinsæœåŠ¡,é»˜è®¤ç«¯å£8080.<br>è¿™æ ·å°±å¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ä»¥ä¸‹åœ°å€å°±å¯ä»¥æ‰“å¼€jenkinsäº†ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8080</span><br></pre></td></tr></table></figure>
<h3 id="jenkins-ç›¸å…³å¯åŠ¨å‘½ä»¤"><a href="#jenkins-ç›¸å…³å¯åŠ¨å‘½ä»¤" class="headerlink" title="jenkins ç›¸å…³å¯åŠ¨å‘½ä»¤"></a>jenkins ç›¸å…³å¯åŠ¨å‘½ä»¤</h3><ol>
<li><p>é»˜è®¤æƒ…å†µä¸‹å®‰è£…å®ŒdmgåŒ…ï¼Œmacç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆå…¨å±€å˜é‡ï¼šjenkins(å˜é‡åœ°å€ï¼š/usr/local/Cellar/jenkins/1.618/libexec/jenkins.war)ï¼Œåªè¦åœ¨å‘½ä»¤è¡Œä¸­ç›´æ¥è¾“å…¥jenkins + ç›¸å…³å‚æ•° å³å¯è¿è¡Œç›¸å…³å‘½ä»¤ã€‚å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd$:jenkins --httpPort=8888 #æ›´æ¢ç«¯å£å·ï¼Œå½“é»˜è®¤ç«¯å£8080è¢«å ç”¨ï¼Œæˆ–è€…æŒ‡å®šç‰¹å®šç«¯å£æ—¶ã€‚</span><br></pre></td></tr></table></figure>
</li>
<li><p>ç”±äºmacç³»ç»Ÿç‰ˆæœ¬çš„ä¸åŒï¼Œå¯èƒ½ä¼šå¯¼è‡´åœ¨ä¸€äº›ç¯å¢ƒä¸­æ— æ³•ç›´æ¥ä½¿ç”¨jenkinså…¨å±€å˜é‡ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦æ‰¾åˆ°å®‰è£…çš„åº”ç”¨ç¨‹åºä¸­jenkinsæ–‡ä»¶å¤¹ä¸‹çš„jenk.waræ¥å¯åŠ¨æˆ–è€…æ‰§è¡Œå‘½ä»¤.å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd$:java -jar /Applications/Jenkins/jenkins.war --httpPort=8888</span><br></pre></td></tr></table></figure>
<p>ç›¸å…³å‚æ•° å¯ä»¥é€šè¿‡åœ¨åé¢è¿½åŠ  â€“help æŸ¥çœ‹ï¼šå¦‚ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  Running from: /usr/local/Cellar/jenkins/1.618/libexec/jenkins.war</span><br><span class="line">webroot: $user.home/.jenkins</span><br><span class="line">Jenkins Continuous Integration Engine 1.618</span><br><span class="line">Usage: java -jar jenkins.war [--option=value] [--option=value]</span><br></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">Options:</span><br><span class="line">   --extractedFilesFolder   = folder where extracted files are to be located. Default is the temp folder</span><br><span class="line">   --daemon                 = fork into background and run as daemon (Unix only)</span><br><span class="line">   --config                 = load configuration properties from here. Default is ./winstone.properties</span><br><span class="line">   --prefix                 = add this prefix to all URLs (eg http://localhost:8080/prefix/resource). Default is none</span><br><span class="line">   --commonLibFolder        = folder for additional jar files. Default is ./lib</span><br><span class="line"></span><br><span class="line">   --logfile                = redirect log messages to this file</span><br><span class="line">   --logThrowingLineNo      = show the line no that logged the message (slow). Default is false</span><br><span class="line">   --logThrowingThread      = show the thread that logged the message. Default is false</span><br><span class="line">   --debug                  = set the level of debug msgs (1-9). Default is 5 (INFO level)</span><br><span class="line"></span><br><span class="line">   --httpPort               = set the http listening port. -1 to disable, Default is 8080</span><br><span class="line">   --httpListenAddress      = set the http listening address. Default is all interfaces</span><br><span class="line">   --httpDoHostnameLookups  = enable host name lookups on incoming http connections (true/false). Default is false</span><br><span class="line">   --httpKeepAliveTimeout   = how long idle HTTP keep-alive connections are kept around (in ms; default 5000)?</span><br><span class="line">   --httpsPort              = set the https listening port. -1 to disable, Default is disabled</span><br><span class="line">                              if neither --httpsCertificate nor --httpsKeyStore are specified,</span><br><span class="line">                              https is run with one-time self-signed certificate.</span><br><span class="line">   --httpsListenAddress     = set the https listening address. Default is all interfaces</span><br><span class="line">   --httpsDoHostnameLookups = enable host name lookups on incoming https connections (true/false). Default is false</span><br><span class="line">   --httpsKeepAliveTimeout   = how long idle HTTPS keep-alive connections are kept around (in ms; default 5000)?</span><br><span class="line">   --httpsKeyStore          = the location of the SSL KeyStore file.</span><br><span class="line">   --httpsKeyStorePassword  = the password for the SSL KeyStore file. Default is null</span><br><span class="line">   --httpsCertificate       = the location of the PEM-encoded SSL certificate file.</span><br><span class="line">                              (the one that starts with &apos;-----BEGIN CERTIFICATE-----&apos;)</span><br><span class="line">                              must be used with --httpsPrivateKey.</span><br><span class="line">   --httpsPrivateKey        = the location of the PEM-encoded SSL private key.</span><br><span class="line">                              (the one that starts with &apos;-----BEGIN RSA PRIVATE KEY-----&apos;)</span><br><span class="line">   --httpsKeyManagerType    = the SSL KeyManagerFactory type (eg SunX509, IbmX509). Default is SunX509</span><br><span class="line">   --spdy                   = Enable SPDY. See http://wiki.eclipse.org/Jetty/Feature/NPN</span><br><span class="line">   --ajp13Port              = set the ajp13 listening port. -1 to disable, Default is disabled</span><br><span class="line">   --ajp13ListenAddress     = set the ajp13 listening address. Default is all interfaces</span><br><span class="line">   --controlPort            = set the shutdown/control port. -1 to disable, Default disabled</span><br><span class="line"></span><br><span class="line">   --handlerCountStartup    = set the no of worker threads to spawn at startup. Default is 5</span><br><span class="line">   --handlerCountMax        = set the max no of worker threads to allow. Default is 40</span><br><span class="line">   --handlerCountMaxIdle    = set the max no of idle worker threads to allow. Default is 5</span><br><span class="line"></span><br><span class="line">   --sessionTimeout         = set the http session timeout value in minutes. Default to what webapp specifies, and then to 60 minutes</span><br><span class="line">   --mimeTypes=ARG          = define additional MIME type mappings. ARG would be EXT=MIMETYPE:EXT=MIMETYPE:...</span><br><span class="line">                              (e.g., xls=application/vnd.ms-excel:wmf=application/x-msmetafile)</span><br><span class="line">   --maxParamCount=N        = set the max number of parameters allowed in a form submission to protect</span><br><span class="line">                              against hash DoS attack (oCERT #2011-003). Default is 10000.</span><br><span class="line">   --usage / --help         = show this message</span><br><span class="line">   --version                = show the version and quit</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Security options:</span><br><span class="line">   --realmClassName               = Set the realm class to use for user authentication. Defaults to ArgumentsRealm class</span><br><span class="line"></span><br><span class="line">   --argumentsRealm.passwd.&lt;user&gt; = Password for user &lt;user&gt;. Only valid for the ArgumentsRealm realm class</span><br><span class="line">   --argumentsRealm.roles.&lt;user&gt;  = Roles for user &lt;user&gt; (comma separated). Only valid for the ArgumentsRealm realm class</span><br><span class="line"></span><br><span class="line">   --fileRealm.configFile         = File containing users/passwds/roles. Only valid for the FileRealm realm class</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Access logging:</span><br><span class="line">   --accessLoggerClassName        = Set the access logger class to use for user authentication. Defaults to disabled</span><br><span class="line">   --simpleAccessLogger.format    = The log format to use. Supports combined/common/resin/custom (SimpleAccessLogger only)</span><br><span class="line">   --simpleAccessLogger.file      = The location pattern for the log file(SimpleAccessLogger only)</span><br></pre></td></tr></table></figure>
<h3 id="jenkins-ç›¸å…³é‡å¯æˆ–è€…å…³é—­å‘½ä»¤"><a href="#jenkins-ç›¸å…³é‡å¯æˆ–è€…å…³é—­å‘½ä»¤" class="headerlink" title="jenkins ç›¸å…³é‡å¯æˆ–è€…å…³é—­å‘½ä»¤"></a>jenkins ç›¸å…³é‡å¯æˆ–è€…å…³é—­å‘½ä»¤</h3><p>jenkins æ‰§è¡Œé‡å¯å‘½ä»¤éœ€è¦åœ¨jenkinsä»¥åŠå¯åŠ¨çš„æƒ…å†µä¸‹æ‰§è¡Œï¼Œæ‰§è¡Œè¯­æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar jenkins-cli.jar [-s URL] command [opts...] args...</span><br></pre></td></tr></table></figure>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šæ‰§è¡Œè¯¥å‘½ä»¤å¼ å¿…é¡»è¦ç™»é™†jenkins ä¹Ÿå°±æ˜¯å¿…è¦çš„ç”¨æˆ·åå’Œå¯†ç æ ¼å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar jenkins-cli.jar help [COMMAND] [--username VAL] [--password VAL] [--password-file VAL] #å…¶ä¸­jenkins-cli.jarè·¯å¾„åœ¨jenkinså®‰è£…ç›®å½•ä¸‹ Jenkins/Home/war/WEB-INF/jenkins-cli.jar</span><br></pre></td></tr></table></figure>
<p>å®ä¾‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo java -jar /Users/Shared/Jenkins/Home/war/WEB-INF/jenkins-cli.jar -s http://localhost:8080 help --username jenkinsç”¨æˆ·å --password å¯†ç </span><br></pre></td></tr></table></figure>
<p>ç›¸å…³æŒ‡ä»¤å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">add-job-to-view</span><br><span class="line">    Adds jobs to view.</span><br><span class="line">  build</span><br><span class="line">    Builds a job, and optionally waits until its completion.</span><br><span class="line">  cancel-quiet-down</span><br><span class="line">    Cancel the effect of the &quot;quiet-down&quot; command.</span><br><span class="line">  clear-queue</span><br><span class="line">    Clears the build queue</span><br><span class="line">  connect-node</span><br><span class="line">    Reconnect to a node</span><br><span class="line">  console</span><br><span class="line">    Retrieves console output of a build.</span><br><span class="line">  copy-job</span><br><span class="line">    Copies a job.</span><br><span class="line">  create-job</span><br><span class="line">    Creates a new job by reading stdin as a configuration XML file.</span><br><span class="line">  create-node</span><br><span class="line">    Creates a new node by reading stdin as a XML configuration.</span><br><span class="line">  create-view</span><br><span class="line">    Creates a new view by reading stdin as a XML configuration.</span><br><span class="line">  delete-builds</span><br><span class="line">    Deletes build record(s).</span><br><span class="line">  delete-job</span><br><span class="line">    Deletes a job</span><br><span class="line">  delete-node</span><br><span class="line">    Deletes a node</span><br><span class="line">  delete-view</span><br><span class="line">    Deletes view(s).</span><br><span class="line">  disable-job</span><br><span class="line">    Disables a job</span><br><span class="line">  disconnect-node</span><br><span class="line">    Disconnects from a node</span><br><span class="line">  enable-job</span><br><span class="line">    Enables a job</span><br><span class="line">  get-job</span><br><span class="line">    Dumps the job definition XML to stdout.</span><br><span class="line">  get-node</span><br><span class="line">    Dumps the node definition XML to stdout.</span><br><span class="line">  get-view</span><br><span class="line">    Dumps the view definition XML to stdout.</span><br><span class="line">  groovy</span><br><span class="line">    Executes the specified Groovy script.</span><br><span class="line">  groovysh</span><br><span class="line">    Runs an interactive groovy shell.</span><br><span class="line">  help</span><br><span class="line">    Lists all the available commands or a detailed description of single command.</span><br><span class="line">  install-plugin</span><br><span class="line">    Installs a plugin either from a file, an URL, or from update center.</span><br><span class="line">  install-tool</span><br><span class="line">    Performs automatic tool installation, and print its location to stdout. Can be only called from inside a build.</span><br><span class="line">  keep-build</span><br><span class="line">    Mark the build to keep the build forever.</span><br><span class="line">  list-changes</span><br><span class="line">    Dumps the changelog for the specified build(s).</span><br><span class="line">  list-jobs</span><br><span class="line">    Lists all jobs in a specific view or item group.</span><br><span class="line">  list-plugins</span><br><span class="line">    Outputs a list of installed plugins.</span><br><span class="line">  login</span><br><span class="line">    Saves the current credential to allow future commands to run without explicit credential information.</span><br><span class="line">  logout</span><br><span class="line">    Deletes the credential stored with the login command.</span><br><span class="line">  mail</span><br><span class="line">    Reads stdin and sends that out as an e-mail.</span><br><span class="line">  offline-node</span><br><span class="line">    Stop using a node for performing builds temporarily, until the next &quot;online-node&quot; command.</span><br><span class="line">  online-node</span><br><span class="line">    Resume using a node for performing builds, to cancel out the earlier &quot;offline-node&quot; command.</span><br><span class="line">  quiet-down</span><br><span class="line">    Quiet down Jenkins, in preparation for a restart. Donâ€™t start any builds.</span><br><span class="line">  reload-configuration</span><br><span class="line">    Discard all the loaded data in memory and reload everything from file system. Useful when you modified config files directly on disk.</span><br><span class="line">  reload-job</span><br><span class="line">    Reload job(s)</span><br><span class="line">  remove-job-from-view</span><br><span class="line">    Removes jobs from view.</span><br><span class="line">  restart</span><br><span class="line">    Restart Jenkins.</span><br><span class="line">  safe-restart</span><br><span class="line">    Safely restart Jenkins.</span><br><span class="line">  safe-shutdown</span><br><span class="line">    Puts Jenkins into the quiet mode, wait for existing builds to be completed, and then shut down Jenkins.</span><br><span class="line">  session-id</span><br><span class="line">    Outputs the session ID, which changes every time Jenkins restarts.</span><br><span class="line">  set-build-description</span><br><span class="line">    Sets the description of a build.</span><br><span class="line">  set-build-display-name</span><br><span class="line">    Sets the displayName of a build.</span><br><span class="line">  set-build-parameter</span><br><span class="line">    Update/set the build parameter of the current build in progress.</span><br><span class="line">  set-build-result</span><br><span class="line">    Sets the result of the current build. Works only if invoked from within a build.</span><br><span class="line">  set-external-build-result</span><br><span class="line">    Set external monitor job result.</span><br><span class="line">  shutdown</span><br><span class="line">    Immediately shuts down Jenkins server.</span><br><span class="line">  update-job</span><br><span class="line">    Updates the job definition XML from stdin. The opposite of the get-job command.</span><br><span class="line">  update-node</span><br><span class="line">    Updates the node definition XML from stdin. The opposite of the get-node command.</span><br><span class="line">  update-view</span><br><span class="line">    Updates the view definition XML from stdin. The opposite of the get-view command.</span><br><span class="line">  version</span><br><span class="line">    Outputs the current version.</span><br><span class="line">  wait-node-offline</span><br><span class="line">    Wait for a node to become offline.</span><br><span class="line">  wait-node-online</span><br><span class="line">    Wait for a node to become online.</span><br><span class="line">  who-am-i</span><br><span class="line">    Reports your credential and permissions.</span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jenkins/">jenkins</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-2016-03-14-Block" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/03/07/2016-03-14-Block/" class="article-date">
      <time datetime="2016-03-07T03:37:21.000Z" itemprop="datePublished">2016-03-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/07/2016-03-14-Block/">Blockæºç è§£æå’Œæ·±å…¥ç†è§£</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h3 id="Blockæºç è§£æå’Œæ·±å…¥ç†è§£"><a href="#Blockæºç è§£æå’Œæ·±å…¥ç†è§£" class="headerlink" title="Blockæºç è§£æå’Œæ·±å…¥ç†è§£"></a>Blockæºç è§£æå’Œæ·±å…¥ç†è§£</h3><h4 id="Blockçš„æœ¬è´¨"><a href="#Blockçš„æœ¬è´¨" class="headerlink" title="Blockçš„æœ¬è´¨"></a>Blockçš„æœ¬è´¨</h4><p>Blockæ˜¯â€å¸¦æœ‰è‡ªåŠ¨å˜é‡å€¼çš„åŒ¿åå‡½æ•°â€.<br>æˆ‘ä»¬é€šè¿‡Clangï¼ˆLLVMç¼–è¯‘å™¨ï¼‰æ¥å°†OCçš„ä»£ç è½¬æ¢æˆC++æºç çš„å½¢å¼ï¼Œé€šè¿‡å¦‚ä¸‹å‘½ä»¤ï¼š</p>
<pre><code>clang -rewrite-objc æºä»£ç æ–‡ä»¶å
</code></pre><p>ä¸‹é¢ï¼Œæˆ‘ä»¬è¦è½¬æ¢çš„Blockè¯­æ³•</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">void</span> (^blk)(<span class="keyword">void</span>) = ^&#123;</span><br><span class="line">        printf(<span class="string">"Block\n"</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    blk();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯¥æºä»£ç é€šè¿‡Clang å¯å˜æ¢ä¸ºä»¥ä¸‹å½¢å¼ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line">    __block_impl ï¼ˆblockï¼‰ç»“æ„ä½“å£°æ˜</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">struct</span> __block_impl &#123;</span><br><span class="line">  <span class="keyword">void</span> *isa; <span class="comment">// isa æŒ‡é’ˆï¼ŒæŒ‡å‘çˆ¶ç±»çš„å®ä¾‹ã€‚void * ç›¸å½“äº id æ˜¯ä¸ªå®ä¾‹ã€‚</span></span><br><span class="line">  <span class="keyword">int</span> Flags; <span class="comment">// </span></span><br><span class="line">  <span class="keyword">int</span> Reserved;</span><br><span class="line">  <span class="keyword">void</span> *FuncPtr; <span class="comment">//å‡½æ•°æŒ‡é’ˆ æŒ‡å‘blockä»£ç å—çš„å®ç°å‡½æ•°</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/*</span><br><span class="line">    __main_block_impl_0 åŒ¿åçš„block ç»“æ„ä½“å£°æ˜å’Œå®ç°</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">struct</span> __main_block_impl_0 &#123;</span><br><span class="line">  <span class="keyword">struct</span> __block_impl impl;<span class="comment">//block çš„ç»“æ„ä½“å®ä¾‹</span></span><br><span class="line">  <span class="keyword">struct</span> __main_block_desc_0* Desc; <span class="comment">//block desçš„æŒ‡é’ˆ æŒ‡å‘blockçš„è¯¦æƒ…</span></span><br><span class="line">  <span class="comment">/*</span><br><span class="line">    __main_block_impl_0 ç»“æ„ä½“æ„é€ å‡½æ•°å®ç°</span><br><span class="line">  */</span></span><br><span class="line">  __main_block_impl_0(<span class="keyword">void</span> *fp, <span class="keyword">struct</span> __main_block_desc_0 *desc, <span class="keyword">int</span> flags=<span class="number">0</span>) &#123;</span><br><span class="line">    impl.isa = &amp;_<span class="built_in">NSConcreteStackBlock</span>; <span class="comment">// åˆå§‹åŒ– block å®ä¾‹å±æ€§ isa ï¼Œè¡¨ç¤ºè¯¥block æ˜¯ _NSConcreteStackBlock (æ ˆ)ç±»å‹çš„ä»£ç å—</span></span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;<span class="comment">// block å…·ä½“çš„å‡½æ•°å®ç°æŒ‡é’ˆ</span></span><br><span class="line">    Desc = desc;<span class="comment">//desc æŒ‡é’ˆ</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/*</span><br><span class="line">     åŒ¿åblock å…·ä½“çš„å‡½æ•°å®ç°</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(<span class="keyword">struct</span> __main_block_impl_0 *__cself) &#123;</span><br><span class="line"></span><br><span class="line">        printf(<span class="string">"Block\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">/*</span><br><span class="line">    åŒ¿åblock desc æŒ‡é’ˆçš„å…·ä½“å‡½æ•°å®ç°ï¼Œå¯¹blockï¼ˆ__main_block_impl_0ï¼‰ ç»“æ„ä½“å®ä¾‹çš„å¤§å°è¿›è¡Œåˆå§‹åŒ–</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> __main_block_desc_0 &#123;</span><br><span class="line">  size_t reserved; <span class="comment">// å‡çº§æ‰€éœ€åŒºåŸŸ</span></span><br><span class="line">  size_t Block_size;<span class="comment">//block å®é™…å†…å­˜å¤§å°</span></span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __main_block_impl_0)&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span><br><span class="line">    æŠŠå¤šä½™çš„è½¬æ¢å»æ‰ï¼Œçœ‹èµ·æ¥å°±æ¯”è¾ƒæ¸…æ¥šäº†ï¼š</span><br><span class="line">    ç¬¬ä¸€éƒ¨åˆ†ï¼šblockçš„åˆå§‹åŒ–</span><br><span class="line">    __main_block_func_0: å‚æ•°ä¸€ æ˜¯blockè¯­æ³•è½¬æ¢çš„Cè¯­è¨€å‡½æ•°æŒ‡é’ˆã€‚</span><br><span class="line">    __main_block_desc_0_DATAï¼š å‚æ•°äºŒ ä½œä¸ºé™æ€å…¨å±€å˜é‡åˆå§‹åŒ–çš„ __main_block_desc_0 ç»“æ„ä½“å®ä¾‹æŒ‡é’ˆ</span><br><span class="line">    struct __main_block_impl_0 tmp = __main_block_impl_0(__main_block_func_0, &amp;__main_block_desc_0_DATA);</span><br><span class="line">    struct __main_block_impl_0 *blk = &amp;tmp;</span><br><span class="line">    ç¬¬äºŒéƒ¨åˆ†ï¼š</span><br><span class="line">    blockçš„æ‰§è¡Œï¼š blk()</span><br><span class="line">    å»æ‰è½¬åŒ–éƒ¨åˆ†ï¼š</span><br><span class="line">       (*blk -&gt; imp.FuncPtr)(blk);</span><br><span class="line">    è¿™å°±æ˜¯ç®€å•åœ°ä½¿ç”¨å‡½æ•°æŒ‡é’ˆè°ƒç”¨å‡½æ•°ã€‚ç”±Blockè¯­æ³•è½¬æ¢çš„ __main_block_func_0 å‡½æ•°çš„æŒ‡é’ˆè¢«èµ‹å€¼æˆå‘˜å˜é‡FuncPträ¸­ï¼Œå¦å¤– __main_block_func_0çš„å‡½æ•°çš„å‚æ•° __cself æŒ‡å‘Blockçš„å€¼ï¼Œé€šè¿‡æºç å¯ä»¥çœ‹å‡º Block æ­£å¼ä½œä¸ºå‚æ•°è¿›è¡Œä¼ é€’çš„ã€‚</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">void</span> (*blk)(<span class="keyword">void</span>) = ((<span class="keyword">void</span> (*)())&amp;__main_block_impl_0((<span class="keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA));</span><br><span class="line">    ((<span class="keyword">void</span> (*)(__block_impl *))((__block_impl *)blk)-&gt;FuncPtr)((__block_impl *)blk);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é’ˆå¯¹æºç çš„è§£é‡Š å¤§éƒ¨åˆ†åœ¨ä»£ç ä¸­éƒ½æ³¨é‡Šäº†ã€‚éœ€è¦ç‰¹åˆ«æŒ‡å‡ºçš„æ˜¯ï¼š</p>
<pre><code>static void __main_block_func_0(struct __main_block_impl_0 *__cself) 
</code></pre><p>ä¸­çš„å‚æ•° <strong>cself æ˜¯æŒ‡å‘ </strong>main_block_impl_0 çš„æŒ‡é’ˆï¼ŒåŠåŒ¿åblock è‡ªèº«ã€‚<br>æ‰©å±•ï¼šè¯¥å¥æºç ç±»ä¼¼å¦‚ OC ä¸­çš„æ–¹æ³•æ¶ˆæ¯ä¼ é€’ï¼ŒOCä¸­æ¯ä¸ªæ–¹æ³•éƒ½é»˜è®¤å¸¦ä¸¤ä¸ªå‚æ•° ä¸€ä¸ªæ˜¯æŒ‡å‘è‡ªèº«çš„å®ä¾‹self ä¸€ä¸ªæ˜¯è¯¥æ–¹æ³•çš„SEL å¯¹è±¡ã€‚<br>ä¾‹å¦‚ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>) method: (<span class="keyword">int</span>)argc&#123;</span><br><span class="line">    NLog(<span class="string">@"%p %d \n"</span>,<span class="keyword">self</span>,arg)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Objective - C ç¼–è¯‘å™¨åŒC++çš„æ–¹æ³•ä¸€æ ·ï¼Œä¹Ÿå°†è¯¥æ–¹æ³•ä½œä¸ºCè¯­è¨€çš„å‡½æ•°æ¥å¤„ç†.æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line">    æ–¹æ³•ä¸­ åœ¨è½¬æ¢æˆæºç å è‡ªåŠ¨çš„æ·»åŠ äº†self, _cmdä¸¤ä¸ªå‚æ•° </span><br><span class="line">*/</span></span><br><span class="line">    <span class="keyword">void</span> _I_MyObjct_method_(<span class="keyword">struct</span> Myobject *<span class="keyword">self</span>,SEL _cmd, <span class="keyword">int</span> arg)&#123;</span><br><span class="line">        <span class="built_in">NSLog</span> (<span class="string">@"%p %d \n"</span>,<span class="keyword">self</span>,arg);</span><br><span class="line">    &#125;</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line"><span class="meta">#### æˆªè·è‡ªåŠ¨å˜é‡å€¼ï¼ˆå±€éƒ¨å˜é‡ï¼‰</span></span><br><span class="line"></span><br><span class="line">```objc </span><br><span class="line"><span class="keyword">struct</span> __main_block_impl_0 &#123;</span><br><span class="line">  <span class="keyword">struct</span> __block_impl impl;</span><br><span class="line">  <span class="keyword">struct</span> __main_block_desc_0* Desc;</span><br><span class="line">  <span class="keyword">int</span> val; <span class="comment">//å±€éƒ¨å˜é‡è·Ÿblockå¤–çš„ç±»å‹ä¸€ç›´</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *fmt; <span class="comment">//è·Ÿblockå¤–çš„ç±»å‹ä¸€è‡´</span></span><br><span class="line">  __main_block_impl_0(<span class="keyword">void</span> *fp, <span class="keyword">struct</span> __main_block_desc_0 *desc, <span class="keyword">int</span> _dmy, <span class="keyword">int</span> _val, <span class="keyword">const</span> <span class="keyword">char</span> *_fmt, <span class="keyword">int</span> flags=<span class="number">0</span>) : dmy(_dmy), val(_val), fmt(_fmt) &#123;</span><br><span class="line">    impl.isa = &amp;_<span class="built_in">NSConcreteStackBlock</span>;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(<span class="keyword">struct</span> __main_block_impl_0 *__cself) &#123;</span><br><span class="line">  <span class="keyword">int</span> val = __cself-&gt;val; <span class="comment">// bound by copy //block è°ƒç”¨å¤–éƒ¨çš„å±€éƒ¨å˜é‡ å®é™…ä¸Š ç›¸å½“äºCopy äº†ä¸€ä»½ æ‰€ä»¥ä¸ä¼šå½±å“ å±€éƒ¨å˜é‡çš„å€¼ ä¹Ÿä¸èƒ½ä¿®æ”¹å€¼ </span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *fmt = __cself-&gt;fmt; <span class="comment">// bound by copy</span></span><br><span class="line"></span><br><span class="line">        printf(<span class="string">"Block\n .. ,%d %s"</span>,dmy,val,fmt);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> __main_block_desc_0 &#123;</span><br><span class="line">  size_t reserved;</span><br><span class="line">  size_t Block_size;</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __main_block_impl_0)&#125;;</span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">int</span> dmy = <span class="number">256</span>; <span class="comment">//å±€éƒ¨å˜é‡ </span></span><br><span class="line">    <span class="keyword">int</span> val = <span class="number">10</span>; <span class="comment">// å±€éƒ¨å˜é‡</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *fmt = <span class="string">"val = %d \n"</span>; <span class="comment">//å±€éƒ¨å˜é‡</span></span><br><span class="line">    <span class="keyword">void</span> (*blk)(<span class="keyword">void</span>) = ((<span class="keyword">void</span> (*)())&amp;__main_block_impl_0((<span class="keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, val, fmt));</span><br><span class="line">    ((<span class="keyword">void</span> (*)(__block_impl *))((__block_impl *)blk)-&gt;FuncPtr)((__block_impl *)blk);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æºç è§£æï¼šblock åœ¨è°ƒç”¨ å¤–éƒ¨å±€éƒ¨å˜é‡çš„æ—¶å€™ å…¶å®æ˜¯å°†å¤–éƒ¨å±€éƒ¨å˜é‡ copyäº†ä¸€ä»½ ä½¿ç”¨çš„ æ‰€ä»¥åœ¨æ²¡æœ‰ä»»ä½•ä¿®é¥°ç¬¦çš„æ—¶å€™æ˜¯ä¸å¯ä»¥ä¿®æ”¹å¤–éƒ¨å±€éƒ¨å˜é‡çš„ã€‚</p>
<h4 id="block-è¯´æ˜ç¬¦"><a href="#block-è¯´æ˜ç¬¦" class="headerlink" title="__block è¯´æ˜ç¬¦"></a>__block è¯´æ˜ç¬¦</h4><p>ä¹‹å‰çš„åˆ†æä¸­ï¼Œblock æ— æ³•æ”¹å˜è¢«æˆªè·çš„è‡ªåŠ¨å˜é‡çš„å€¼ã€‚è¿™æ ·æä¸ºä¸ä¾¿ï¼š<br>è§£å†³è¿™ä¸ªé—®é¢˜æœ‰ä¸¤ç§æ–¹æ³•ï¼Œ<br><strong>ç¬¬ä¸€ç§ï¼šC è¯­è¨€ä¸­æœ‰ä¸€ä¸ªå˜é‡ï¼Œå…è®¸blockæ”¹æˆå€¼ã€‚å…·ä½“å¦‚ä¸‹ï¼š</strong></p>
<ul>
<li>é™æ€å˜é‡</li>
<li>é™æ€å…¨å±€å˜é‡</li>
<li><p>å…¨å±€å˜é‡</p>
<p>è™½ç„¶Blockè¯­æ³•çš„åŒ¿åå‡½æ•°éƒ¨åˆ†ç®€å•çš„è½¬æ¢ä¸ºäº†Cè¯­è¨€å‡½æ•°ï¼Œä½†ä»è¿™ä¸ªCè¯­è¨€å‡½æ•°ä¸­è®¿é—®é™æ€å…¨å±€ï¼Œå…¨å±€å˜é‡å¹¶æ²¡æœ‰ä»»ä½•æ”¹å˜ï¼Œå¯ç›´æ¥ä½¿ç”¨ã€‚<br>ä½†é™æ€å˜é‡çš„æƒ…å†µï¼Œè½¬æ¢åçš„å‡½æ•°åŸæœ¬å°±è®¾ç½®åœ¨å«æœ‰Blockè¯­æ³•çš„å‡½æ•°å¤–ï¼Œæ‰€ä»¥æ— æ³•ä»å˜é‡ä½œç”¨åŸŸè®¿é—®ã€‚<br>çœ‹çœ‹è¿™æ®µä»£ç çš„æºç ï¼š</p>
<pre><code> int global_val = 1;

 static int static_global_val = 2;

 int main(int argc, const char * argv[]) {

static int static_val = 3;

void (^blk)(void) = ^{

    global_val += 1;

    static_global_val += 2;

    static_val += 3;
</code></pre></li>
</ul>
<pre><code>};

blk();

return 0;

}
</code></pre><p> è¯¥æºä»£ç ä¸­ä½¿ç”¨äº†Block æ”¹å†™é™æ€å˜é‡ é™æ€å…¨å±€å˜é‡ å…¨å±€å˜é‡ã€‚è¯¥æºä»£ç è½¬æ¢åå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">int global_val = 1; //å…¨å±€å˜é‡</span><br><span class="line"> static int static_global_val = 2; //é™æ€å…¨å±€å˜é‡</span><br><span class="line">			</span><br><span class="line"> struct __main_block_impl_0 &#123;</span><br><span class="line">		  struct __block_impl impl;</span><br><span class="line">		  struct __main_block_desc_0* Desc;</span><br><span class="line">		  int *static_val;//å±€éƒ¨é™æ€å˜é‡   ---&gt;  å¯ä»¥çœ‹å‡º è·Ÿå±€éƒ¨å˜é‡ä¸åŒ è¿™è¾¹æ˜¯æ¥å—çš„æŒ‡é’ˆ</span><br><span class="line">		  __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int *_static_val, int flags=0) : static_val(_static_val) &#123;</span><br><span class="line">		    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">		    impl.Flags = flags;</span><br><span class="line">		    impl.FuncPtr = fp;</span><br><span class="line">		    Desc = desc;</span><br><span class="line">		  &#125;</span><br><span class="line">		&#125;;</span><br><span class="line">		static void __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</span><br><span class="line">		  int *static_val = __cself-&gt;static_val; // bound by copy // æ”¹ä»£ç è·Ÿå±€éƒ¨å˜é‡ ç›¸ä¼¼ï¼Œå®é™…ä¸Šæ”¹å˜çš„æ˜¯ä¸€ä¸ª å¤åˆ¶åçš„æŒ‡é’ˆ.ä½†è¯¥æŒ‡é’ˆæœ€ç»ˆæŒ‡å‘çš„ è¿˜æ˜¯æœ€åˆçš„å˜é‡å€¼ã€‚</span><br><span class="line">		</span><br><span class="line">		        global_val += 1;</span><br><span class="line">		        static_global_val += 2;</span><br><span class="line">		        (*static_val) += 3;</span><br><span class="line">		</span><br><span class="line">		    &#125;</span><br><span class="line">		</span><br><span class="line">		static struct __main_block_desc_0 &#123;</span><br><span class="line">		  size_t reserved;</span><br><span class="line">		  size_t Block_size;</span><br><span class="line">		&#125; __main_block_desc_0_DATA = &#123; 0, sizeof(struct __main_block_impl_0)&#125;;</span><br><span class="line">		int main(int argc, const char * argv[]) &#123;</span><br><span class="line">		    static int static_val = 3;</span><br><span class="line">		    void (*blk)(void) = ((void (*)())&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA, &amp;static_val));</span><br><span class="line">		    ((void (*)(__block_impl *))((__block_impl *)blk)-&gt;FuncPtr)((__block_impl *)blk);</span><br><span class="line">		    return 0;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ†æè¯¥æºç ï¼šå‘ç°æ— è®ºæ˜¯å…¨å±€ è¿˜æ˜¯ é™æ€å…¨å±€ éƒ½å¯ä»¥åœ¨Blockä¸­ç›´æ¥è®¿é—® ä¿®æ”¹å˜é‡å€¼ã€‚</p>
<p>ç„¶è€Œï¼Œé™æ€å±€éƒ¨å˜é‡ï¼Œè²Œä¼¼ä¹Ÿå¯ä»¥æ­£å¸¸è®¿é—®ï¼Œå…¶è°ƒç”¨åŸç†ï¼Œè·Ÿä¹‹å‰çš„å±€éƒ¨å˜é‡çš„è°ƒç”¨ç›¸ä¼¼ï¼Œå”¯ä¸€çš„ä¸åŒæ˜¯ï¼Œåœ¨Blockä¸­è°ƒç”¨çš„æ˜¯ æŒ‡å‘è¯¥å˜é‡çš„æŒ‡é’ˆï¼Œå¹¶ä¸”æ˜¯èµ‹å€¼äº†ä¸€ä»½æŒ‡é’ˆï¼ˆä½†è¿˜æ˜¯æœ€ç»ˆæŒ‡å‘åŸæ¥çš„å˜é‡ï¼‰ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨Blockä¸­æ”¹å˜åŸç†å˜é‡çš„å€¼ã€‚<br>    è¿™æ ·å°±æœ‰ä¸ªç–‘é—®ï¼Œæˆ‘ä»¬ä¸ºä»€ä¹ˆä¸ä½¿ç”¨é™æ€å±€éƒ¨å˜é‡ï¼Œæ¥ä½¿ç”¨å»è‡ªåŠ¨å˜é‡ï¼ˆå±€éƒ¨å˜é‡ï¼‰çš„è®¿é—®å‘¢ï¼Ÿ<br>    åŸå› ï¼šåœ¨è¯¥é™æ€å±€éƒ¨å˜é‡ï¼Œæœ‰å˜é‡ä½œç”¨åŸŸï¼Œå½“blockè¶…å‡ºäº†è¯¥ä½œç”¨åŸŸï¼Œæ‰§è¡Œçš„æ—¶å€™ï¼Œå…¶å†…éƒ¨è°ƒç”¨çš„é™æ€å±€éƒ¨å˜é‡ä¼šè¢«åºŸå¼ƒï¼Œæˆ‘ä»¬å°±æ— æ³•è°ƒç”¨åˆ°ã€‚å› æ­¤Blockä¸­è¶…å‡ºå˜é‡ä½œç”¨åŸŸè€Œå­˜åœ¨çš„å˜é‡åŒé™æ€å˜é‡ä¸€æ ·ï¼Œå°†ä¸èƒ½é€šè¿‡æŒ‡é’ˆè®¿é—®åŸæ¥çš„è‡ªåŠ¨å˜é‡ã€‚</p>
<p><strong>è§£å†³Block ä¸­ä¸èƒ½ä¿å­˜å€¼è¿™ä¸€é—®é¢˜çš„ç¬¬äºŒä¸ªæ–¹æ³•æ˜¯ä½¿ç”¨__block</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    __block <span class="keyword">int</span> val = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">void</span> (^blk)(<span class="keyword">void</span>) = ^&#123;</span><br><span class="line">        val = <span class="number">1</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    blk();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å°†ä¸Šé¢ä»£ç ç”¨ clang è½¬åŒ–åå¦‚ä¸‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line">	__block è½¬åŒ–æˆäº†ç»“æ„ä½“ </span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">struct</span> __Block_byref_val_0 &#123;</span><br><span class="line">  <span class="keyword">void</span> *__isa;</span><br><span class="line">__Block_byref_val_0 *__forwarding; <span class="comment">//ç›¸å½“äºä¸€ä¸ªæŒ‡å‘æºå˜é‡çš„æŒ‡é’ˆ</span></span><br><span class="line"> <span class="keyword">int</span> __flags;</span><br><span class="line"> <span class="keyword">int</span> __size;</span><br><span class="line"> <span class="keyword">int</span> val; <span class="comment">//ç›¸å½“äºæºå˜é‡</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> __main_block_impl_0 &#123;</span><br><span class="line">  <span class="keyword">struct</span> __block_impl impl;</span><br><span class="line">  <span class="keyword">struct</span> __main_block_desc_0* Desc;</span><br><span class="line">  __Block_byref_val_0 *val; <span class="comment">// by ref //æŒæœ‰æºå˜é‡çš„ç»“æ„ä½“å®ä¾‹</span></span><br><span class="line">  __main_block_impl_0(<span class="keyword">void</span> *fp, <span class="keyword">struct</span> __main_block_desc_0 *desc, __Block_byref_val_0 *_val, <span class="keyword">int</span> flags=<span class="number">0</span>) : val(_val-&gt;__forwarding) &#123;</span><br><span class="line">    impl.isa = &amp;_<span class="built_in">NSConcreteStackBlock</span>; <span class="comment">// block ä¸ºæ ˆç±»å‹</span></span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(<span class="keyword">struct</span> __main_block_impl_0 *__cself) &#123;</span><br><span class="line">  __Block_byref_val_0 *val = __cself-&gt;val; <span class="comment">// bound by ref ï¼›ç±»ä¼¼äº é™æ€å±€éƒ¨å˜é‡ éƒ½æ˜¯copy ä¸€ä»½æŒ‡å‘æºå˜é‡çš„ç»“æ„ä½“æŒ‡é’ˆã€‚</span></span><br><span class="line"></span><br><span class="line">        (val-&gt;__forwarding-&gt;val) = <span class="number">1</span>;<span class="comment">//é€šè¿‡è®¿é—® __block ç»“æ„ä½“ æˆå‘˜å˜é‡ __forwarding æ¥è®¿é—®æºå˜é‡</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_copy_0(<span class="keyword">struct</span> __main_block_impl_0*dst, <span class="keyword">struct</span> __main_block_impl_0*src) &#123;_Block_object_assign((<span class="keyword">void</span>*)&amp;dst-&gt;val, (<span class="keyword">void</span>*)src-&gt;val, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_dispose_0(<span class="keyword">struct</span> __main_block_impl_0*src) &#123;_Block_object_dispose((<span class="keyword">void</span>*)src-&gt;val, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> __main_block_desc_0 &#123;</span><br><span class="line">  size_t reserved;</span><br><span class="line">  size_t Block_size;</span><br><span class="line">  <span class="keyword">void</span> (*<span class="keyword">copy</span>)(<span class="keyword">struct</span> __main_block_impl_0*, <span class="keyword">struct</span> __main_block_impl_0*);</span><br><span class="line">  <span class="keyword">void</span> (*dispose)(<span class="keyword">struct</span> __main_block_impl_0*);</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __main_block_impl_0), __main_block_copy_0, __main_block_dispose_0&#125;;</span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    __attribute__((__blocks__(<span class="keyword">byref</span>))) __Block_byref_val_0 val = &#123;(<span class="keyword">void</span>*)<span class="number">0</span>,(__Block_byref_val_0 *)&amp;val, <span class="number">0</span>, <span class="keyword">sizeof</span>(__Block_byref_val_0), <span class="number">3</span>&#125;;</span><br><span class="line">    <span class="keyword">void</span> (*blk)(<span class="keyword">void</span>) = ((<span class="keyword">void</span> (*)())&amp;__main_block_impl_0((<span class="keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, (__Block_byref_val_0 *)&amp;val, <span class="number">570425344</span>));</span><br><span class="line">    ((<span class="keyword">void</span> (*)(__block_impl *))((__block_impl *)blk)-&gt;FuncPtr)((__block_impl *)blk);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æºç è§£æï¼š<strong>Block_byref_val_0 ç»“æ„ä½“å®ä¾‹çš„æˆå‘˜å˜é‡</strong>forwardingæŒæœ‰æŒ‡å‘è¯¥å®ä¾‹è‡ªèº«çš„æŒ‡é’ˆã€‚é€šè¿‡æˆå‘˜å˜é‡__forwardingè®¿é—®æˆå‘˜å˜é‡valã€‚ï¼ˆæˆå‘˜å˜é‡valæ˜¯è¯¥å®ä¾‹è‡ªèº«æŒæœ‰çš„å˜é‡ï¼Œå®ƒç›¸å½“äºåŸè‡ªåŠ¨å˜é‡ï¼‰<br>å¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="../images/ç¬”è®°äºŒ/__forwarding.png" alt=""></p>
<p><em>Blockå­˜å‚¨åŸŸ</em><br>Block æ˜¯Objective-Cå¯¹è±¡ã€‚ä¸Šé¢æˆ‘ä»¬æ‰€åˆ›å»ºçš„blockç±» éƒ½ä¸º_NSConcreteStackBlock.<br>ç”±ä¸Šé¢æˆ‘ä»¬æåˆ°çš„æºç å¯ä»¥çŸ¥é“ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impl.isa = &amp;_<span class="built_in">NSConcreteStackBlock</span></span><br></pre></td></tr></table></figure>
<p>æ ¹æ® block ç»“æ„ä½“å®ä¾‹çš„ isa æŒ‡é’ˆè¿›è¡Œåˆ†ç±»ï¼š</p>
<ul>
<li>_NSConcreteStackBlock //ä¸éš¾çœ‹å‡º å…¶å­˜å‚¨åŸŸåœ¨æ ˆä¸Š</li>
<li>_NSConcreteGlobalBlock // å…¶å­˜å‚¨åŸŸ åœ¨å…¨å±€</li>
<li>_NSConcreteMallocBlock // å…¶å­˜å‚¨åŸŸ åœ¨å †ä¸Š<br>è¯¦ç»†åˆ†ç±»å¦‚å›¾æ‰€ç¤ºï¼š</li>
</ul>
<p><img src="../images/ç¬”è®°äºŒ/blockç±»å‹.png" alt=""></p>
<p>_NSConcreteGlobalBlockï¼š å­˜åœ¨çš„æƒ…å†µï¼š</p>
<ul>
<li>è®°è¿°å…¨å±€å˜é‡çš„åœ°æ–¹æœ‰Blockè¯­æ³•æ—¶</li>
<li>Blockè¯­æ³•çš„è¡¨è¾¾å¼ä¸­ä¸ä½¿ç”¨åº”æˆªè·çš„è‡ªåŠ¨å˜é‡æ—¶</li>
<li>ä»¥ä¸Šæƒ…å†µBlock ä¸º å…¨å±€ç±»å¯¹è±¡ã€‚é™¤æ­¤ä¹‹å¤–Blockè¯­æ³•ç”Ÿæˆçš„Blockä¸ºæ ˆç±»å¯¹è±¡ï¼Œ<br>ä¾‹å¦‚ï¼ˆä¸€ï¼‰ï¼š</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line">	åœ¨ä¸‹é¢çš„blockä¸­ç”±äºforå¾ªç¯çš„å€¼ ä¸€ç›´åœ¨å˜ æ‰€ä»¥Blockæˆªè·çš„å±€éƒ¨å˜é‡ä¸€ç›´åœ¨å˜ã€‚</span><br><span class="line">*/</span></span><br><span class="line">	<span class="keyword">typedef</span> <span class="keyword">int</span> (^blk_t)(<span class="keyword">int</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> rate = <span class="number">0</span>;rate &lt; <span class="number">10</span>; ++rate)&#123;</span><br><span class="line">		blk_t blk = ^(<span class="keyword">int</span> count)&#123;</span><br><span class="line">			<span class="keyword">return</span> rate * count;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>è½¬åŒ–ä¸ºæºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> __main_block_impl_0 &#123;</span><br><span class="line">  <span class="keyword">struct</span> __block_impl impl;</span><br><span class="line">  <span class="keyword">struct</span> __main_block_desc_0* Desc;</span><br><span class="line">  <span class="keyword">int</span> rate;</span><br><span class="line">  __main_block_impl_0(<span class="keyword">void</span> *fp, <span class="keyword">struct</span> __main_block_desc_0 *desc, <span class="keyword">int</span> _rate, <span class="keyword">int</span> flags=<span class="number">0</span>) : rate(_rate) &#123;</span><br><span class="line">    impl.isa = &amp;_<span class="built_in">NSConcreteStackBlock</span>;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ç”±æ­¤å¯è§ è™½ç„¶block å£°æ˜åœ¨å…¨å±€ä¸­ï¼Œä½†ç”±äºblockåˆå§‹åŒ–çš„æ—¶å€™è°ƒç”¨äº†å±€éƒ¨å˜é‡ï¼Œæ‰€ä»¥è¯¥blockåˆ›å»ºæˆæ ˆç±»å‹çš„ã€‚<br>_NSConcreteMallocBlock ï¼šå­˜åœ¨çš„æƒ…å†µ<br>    åœ¨åˆ†æä¹‹å‰æˆ‘ä»¬çœ‹ä¸‹ä¹‹å‰é—ç•™çš„é—®é¢˜ï¼š</p>
<ul>
<li>Block è¶…å‡ºå˜é‡ä½œç”¨åŸŸå¯å­˜åœ¨çš„åŸå› </li>
<li><strong>blockå˜é‡ç”¨ç»“æ„ä½“æˆå‘˜å˜é‡</strong>forwardingå­˜åœ¨çš„åŸå› </li>
</ul>
<p>é…ç½®åœ¨å…¨å±€å˜é‡ä¸Šçš„Block,ä»å˜é‡ä½œç”¨åŸŸå¤–ä¹Ÿå¯ä»¥é€šè¿‡æŒ‡é’ˆå®‰å…¨çš„ä½¿ç”¨ã€‚ä½†è®¾ç½®åœ¨æ ˆä¸Šçš„Blcokï¼Œå¦‚æœå…¶å˜é‡ä½œç”¨åŸŸç»“æŸï¼Œè¯¥Blockå°±è¢«åºŸå¼ƒï¼ŒåŒæ ·çš„<strong>blockä¹Ÿé…ç½®åœ¨æ ˆä¸Šï¼Œæ‰€ä»¥å…¶æ‰€å±çš„å˜é‡ä½œç”¨åŸŸç»“æŸï¼Œåˆ™è¯¥</strong>blockå˜é‡ä¹Ÿä¼šè¢«åºŸå¼ƒã€‚<br>Blockæä¾›äº†å°†Blockå’Œ<strong>blockå˜é‡ä»æ ˆä¸Šå¤åˆ¶åˆ°å †ä¸Šçš„æ–¹æ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜<br><img src="../images/ç¬”è®°äºŒ/å¤åˆ¶åˆ°å †ä¸Š.png" alt=""><br>è€Œ</strong>block å˜é‡ç”¨ç»“æ„ä½“æˆå‘˜å˜é‡<strong>forwardingå¯ä»¥å®ç°æ— è®º</strong>blockå˜é‡é…ç½®åœ¨æ ˆä¸Šè¿˜æ˜¯å †ä¸Šéƒ½èƒ½å¤Ÿæ­£ç¡®çš„è®¿é—®__blockå˜é‡ã€‚</p>
<h4 id="æ·±å…¥ç†è§£blocksæä¾›çš„å¤åˆ¶æ–¹æ³•ç©¶ç«Ÿæ˜¯å•¥ï¼Ÿ"><a href="#æ·±å…¥ç†è§£blocksæä¾›çš„å¤åˆ¶æ–¹æ³•ç©¶ç«Ÿæ˜¯å•¥ï¼Ÿ" class="headerlink" title="æ·±å…¥ç†è§£blocksæä¾›çš„å¤åˆ¶æ–¹æ³•ç©¶ç«Ÿæ˜¯å•¥ï¼Ÿ"></a>æ·±å…¥ç†è§£blocksæä¾›çš„å¤åˆ¶æ–¹æ³•ç©¶ç«Ÿæ˜¯å•¥ï¼Ÿ</h4><p>å®é™…ä¸Šå½“ARCæœ‰æ•ˆæ—¶ï¼Œç¼–è¯‘å™¨ä¼šè¿›è¡Œåˆ¤æ–­è‡ªåŠ¨çš„å°†blockä»æ ˆä¸Šå¤åˆ¶åˆ°å †ä¸Š<br>å¦‚ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">int</span> (^blk_t)(<span class="keyword">int</span>);</span><br><span class="line">	blk_t func (<span class="keyword">int</span> count)&#123;</span><br><span class="line">		<span class="keyword">return</span> ^(<span class="keyword">int</span> count)&#123;</span><br><span class="line">			<span class="keyword">return</span> rate *count;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>æºç è½¬æ¢ä¸ºï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">blk_t func (<span class="keyword">int</span> rate)</span><br><span class="line">&#123;</span><br><span class="line">	blk_t tmp = &amp;__func_block_impl_0(</span><br><span class="line">		_func_block_func_0,&amp;_func_block_desc_0_DATA,rate</span><br><span class="line">	);</span><br><span class="line">	tmp = objc_retainBlock(tmp);</span><br><span class="line">	<span class="keyword">return</span> objc_autoreleaseReturnValue(tmp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ†ææºç ï¼šä»æºç æ¥çœ‹ åœ¨ARCçŠ¶æ€ä¸‹ blockå¤åˆ¶åˆ°å †ä¸Š å®é™…ä¸Šå…¶å¼•ç”¨è®¡æ•°å¢åŠ äº†ã€‚</p>
<h4 id="blockå˜é‡çš„å­˜å‚¨åŸŸ"><a href="#blockå˜é‡çš„å­˜å‚¨åŸŸ" class="headerlink" title="__blockå˜é‡çš„å­˜å‚¨åŸŸ"></a>__blockå˜é‡çš„å­˜å‚¨åŸŸ</h4><p>å½“blockä»æ ˆä¸­ å¤åˆ¶åˆ°å †ä¸Šæ—¶ï¼Œç”±äºblockæŒæœ‰<strong>blockå˜é‡ï¼Œæ‰€ä»¥å…¶</strong>blcokå˜é‡ä¹Ÿä¼šä»æ ˆä¸­å¤åˆ¶åˆ°å †ä¸Šï¼Œæ‰€ä»¥å½“blockè¶…å‡ºä½œç”¨åŸŸè°ƒç”¨<strong>blockå˜é‡ä¹Ÿå¯ä»¥æˆåŠŸã€‚è¿™æ˜¯å’Œé™æ€å±€éƒ¨å˜é‡æœ€å¤§çš„åŒºåˆ«ã€‚è€Œé™æ€å±€éƒ¨å˜é‡ï¼Œåœ¨blockä»æ ˆä¸­å¤åˆ¶åˆ°å †ä¸Šæ—¶ï¼Œç”±äºblockä¸æŒæœ‰å˜é‡ï¼Œæ‰€ä»¥é™æ€å±€éƒ¨å˜é‡ä¸ ä¼šå¤åˆ¶åˆ°å †ä¸Šï¼Œå…¶ä½œç”¨åŸŸæ²¡å˜ã€‚æ•…å‡ºä½œç”¨åŸŸè°ƒç”¨ä¼šå´©æºƒã€‚<br>å¦‚å›¾æ‰€ç¤ºï¼š<br>![](../images/ç¬”è®°äºŒ/</strong>blockæŒæœ‰.png)<br><img src="../images/ç¬”è®°äºŒ/__blockåºŸå¼ƒ.png" alt=""></p>
<h4 id="æˆªè·å¯¹è±¡"><a href="#æˆªè·å¯¹è±¡" class="headerlink" title="æˆªè·å¯¹è±¡"></a>æˆªè·å¯¹è±¡</h4><p>ä¸‹é¢æˆ‘ä»¬å°†idå¯¹è±¡ç±»å‹çš„å±€éƒ¨å˜é‡ åœ¨blockä¸­è°ƒç”¨ã€‚idç±»å‹çš„å¯¹è±¡ é»˜è®¤ä¿®é¥°ç¬¦ éƒ½æ˜¯__strongç±»å‹çš„ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (^blk_t)(<span class="keyword">id</span>);</span><br><span class="line">blk_t blk;</span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">id</span> array = [[<span class="built_in">NSMutableArray</span> alloc]init]; <span class="comment">// __strong ç±»å‹ä¿®æ”¹çš„å±€éƒ¨å˜é‡</span></span><br><span class="line">        blk = [^(<span class="keyword">id</span> objc)&#123;</span><br><span class="line">            [array addObject:objc];</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"array count = %ld"</span>,[array count]);</span><br><span class="line">        &#125; <span class="keyword">copy</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    blk(<span class="string">@"ww"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ†æ ï¼šæŒ‰ç†æ¥è¯´ array å¯¹è±¡å‡ºäº†å¤§æ‹¬å·ä½œç”¨åŸŸï¼Œå¼ºå¼•ç”¨å¤±æ•ˆ å…¶å¯¹è±¡å°±ä¼šåºŸå¼ƒã€‚ä½†æ”¹ä»£ç è¿è¡Œæ­£å¸¸ã€‚é‚£ä¹ˆå°±æ„å‘³ç€ï¼Œarrayå¯¹è±¡å‡ºå¤§æ‹¬å·ä½œç”¨åŸŸæ—¶ï¼Œæ²¡æœ‰è¢«åºŸå¼ƒ ï¼Œä»èƒ½æ­£å¸¸è®¿é—®ã€‚é‚£ä¹ˆæ˜¯ä»€ä¹ˆåŸå› å‘¢ï¼Œæˆ‘ä»¬çœ‹ä¸‹Clangä¹‹åçš„æºç .</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (*blk_t)(<span class="keyword">id</span>);</span><br><span class="line">blk_t blk;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> __main_block_impl_0 &#123;</span><br><span class="line">  <span class="keyword">struct</span> __block_impl impl;</span><br><span class="line">  <span class="keyword">struct</span> __main_block_desc_0* Desc;</span><br><span class="line">  <span class="keyword">id</span> array;</span><br><span class="line">  __main_block_impl_0(<span class="keyword">void</span> *fp, <span class="keyword">struct</span> __main_block_desc_0 *desc, <span class="keyword">id</span> _array, <span class="keyword">int</span> flags=<span class="number">0</span>) : array(_array) &#123;</span><br><span class="line">    impl.isa = &amp;_<span class="built_in">NSConcreteStackBlock</span>;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(<span class="keyword">struct</span> __main_block_impl_0 *__cself, <span class="keyword">id</span> objc) &#123;</span><br><span class="line">  <span class="keyword">id</span> array = __cself-&gt;array; <span class="comment">// bound by copy //å¤åˆ¶ä¸€ä»½æŒ‡é’ˆ èµ‹å€¼</span></span><br><span class="line"></span><br><span class="line">            ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, ObjectType))(<span class="keyword">void</span> *)objc_msgSend)((<span class="keyword">id</span>)array, sel_registerName(<span class="string">"addObject:"</span>), (<span class="keyword">id</span>)objc);</span><br><span class="line">            <span class="built_in">NSLog</span>((<span class="built_in">NSString</span> *)&amp;__<span class="built_in">NSConstantStringImpl__var_folders_0b_9hq6xqxs5gjcxx5j_skhh8n00000gn_T_main_1808b3_mi_0</span>,((<span class="built_in">NSUInteger</span> (*)(<span class="keyword">id</span>, SEL))(<span class="keyword">void</span> *)objc_msgSend)((<span class="keyword">id</span>)array, sel_registerName(<span class="string">"count"</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span><br><span class="line">        		å…³é”®æ–¹æ³•ï¼šè¯¥æ–¹æ³• ç›¸å½“äºARC ä¸­çš„ retainæ–¹æ³•ï¼Œå°†å¯¹è±¡çš„å¼•ç”¨è®¡æ•°åŠ ä¸€ã€‚ä½†è¯¥æ–¹æ³•é™¤å¼•ç”¨è®¡æ•°åŠ ä¸€å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªæ“ä½œå°±æ˜¯å°†block ä»æ ˆä¸Šå¤åˆ¶åˆ°å †ä¸Šï¼Œä»è€Œå¯ä»¥å‡ºä½œç”¨åŸŸï¼Œè°ƒç”¨id __strongä¿®é¥°ç±»å‹çš„å¯¹è±¡ã€‚</span><br><span class="line">        */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_copy_0(<span class="keyword">struct</span> __main_block_impl_0*dst, <span class="keyword">struct</span> __main_block_impl_0*src) &#123;_Block_object_assign((<span class="keyword">void</span>*)&amp;dst-&gt;array, (<span class="keyword">void</span>*)src-&gt;array, <span class="number">3</span><span class="comment">/*BLOCK_FIELD_IS_OBJECT*/</span>);&#125;</span><br><span class="line"><span class="comment">/*</span><br><span class="line">		dispose ç›¸å½“äºARC æ¨¡å¼ä¸‹çš„ release å°†å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å‡ä¸€ã€‚å¼•ç”¨è®¡æ•°å‡ä¸€å¾—åŒæ—¶ï¼Œå°†å †ä¸Šçš„block åºŸå¼ƒæ‰ã€‚</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_dispose_0(<span class="keyword">struct</span> __main_block_impl_0*src) &#123;_Block_object_dispose((<span class="keyword">void</span>*)src-&gt;array, <span class="number">3</span><span class="comment">/*BLOCK_FIELD_IS_OBJECT*/</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> __main_block_desc_0 &#123;</span><br><span class="line">  size_t reserved;</span><br><span class="line">  size_t Block_size;</span><br><span class="line">  <span class="keyword">void</span> (*<span class="keyword">copy</span>)(<span class="keyword">struct</span> __main_block_impl_0*, <span class="keyword">struct</span> __main_block_impl_0*);</span><br><span class="line">  <span class="keyword">void</span> (*dispose)(<span class="keyword">struct</span> __main_block_impl_0*);</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __main_block_impl_0), __main_block_copy_0, __main_block_dispose_0&#125;;</span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">id</span> array = ((<span class="built_in">NSMutableArray</span> *(*)(<span class="keyword">id</span>, SEL))(<span class="keyword">void</span> *)objc_msgSend)((<span class="keyword">id</span>)((<span class="built_in">NSMutableArray</span> *(*)(<span class="keyword">id</span>, SEL))(<span class="keyword">void</span> *)objc_msgSend)((<span class="keyword">id</span>)objc_getClass(<span class="string">"NSMutableArray"</span>), sel_registerName(<span class="string">"alloc"</span>)), sel_registerName(<span class="string">"init"</span>));</span><br><span class="line">        blk = (blk_t)((<span class="keyword">id</span> (*)(<span class="keyword">id</span>, SEL))(<span class="keyword">void</span> *)objc_msgSend)((<span class="keyword">id</span>)((<span class="keyword">void</span> (*)(<span class="keyword">id</span>))&amp;__main_block_impl_0((<span class="keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, array, <span class="number">570425344</span>)), sel_registerName(<span class="string">"copy"</span>));<span class="comment">///å¿…é¡»è°ƒç”¨block çš„copy æ–¹æ³•æ‰èƒ½æ­£å¸¸è¿è¡Œ</span></span><br><span class="line">    &#125;</span><br><span class="line">    ((<span class="keyword">void</span> (*)(__block_impl *, <span class="keyword">id</span>))((__block_impl *)blk)-&gt;FuncPtr)((__block_impl *)blk, (<span class="built_in">NSString</span> *)&amp;__<span class="built_in">NSConstantStringImpl__var_folders_0b_9hq6xqxs5gjcxx5j_skhh8n00000gn_T_main_1808b3_mi_1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>//ä»ä¸Šé¢çš„æºç å¯ä»¥å‘ç°ï¼š<strong>å‰æï¼šå½“blockè°ƒç”¨copyæ–¹æ³•</strong>ï¼Œä»æ ˆä¸­å¤åˆ¶åˆ°å¯¹è±¡ï¼Œå½“Blockè°ƒç”¨çš„å±€éƒ¨å˜é‡æ˜¯ä¸ªidå¯¹è±¡çš„æ—¶å€™ï¼Œè¯¥å¯¹è±¡åœ¨blockä¸­è‡ªåŠ¨çš„å¼•ç”¨è®¡æ•°åŠ ä¸€ï¼Œå¹¶ä¸”è¯¥blockæŒæœ‰è¯¥å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹è±¡å‡ºäº†ä½œç”¨åŸŸä¹Ÿèƒ½è¢«è°ƒç”¨ï¼ŒçŸ¥é“block ä»å †ä¸ŠåºŸå¼ƒæ‰ä¸ºæ­¢ã€‚å¦‚æœblock çš„æœ€åæ²¡æœ‰è°ƒç”¨copyï¼Œé‚£ä¹ˆè¯¥å¯¹è±¡å€¼ï¼Œä¹Ÿä¼šéšç€ä½œç”¨åŸŸçš„ç»“æŸè€Œè¢«åºŸå¼ƒã€‚<br>æ€»ç»“ï¼š</p>
<p>ä»€ä¹ˆæ—¶å€™æ ˆä¸Šçš„Blockä¼šå¤åˆ¶åˆ°å †ä¸Šå‘¢ï¼Ÿ</p>
<ul>
<li>è°ƒç”¨Blockçš„copyå®ä¾‹æ–¹æ³•æ—¶ã€‚</li>
<li>Blockä½œä¸ºå‡½æ•°è¿”å›å€¼è¿”å›æ—¶ã€‚</li>
<li>å°†Blockèµ‹å€¼ç»™é™„æœ‰__strongä¿®é¥°ç¬¦idç±»å‹çš„ç±»æˆ–è€…Blockç±»å‹æˆå‘˜å˜é‡æ—¶ã€‚</li>
<li>åœ¨æ–¹æ³•åä¸­å«æœ‰usingBlockçš„cocoaæ¡†æ¶æ–¹æ³•æˆ–è€…GCDçš„APIä¸­ä¼ é€’Blockæ—¶ã€‚</li>
</ul>
<p>å¯¹è±¡å’Œ__blockçš„åŒºåˆ«ï¼Ÿ</p>
<ul>
<li>å¦‚æœè°ƒç”¨å¯¹è±¡çš„Blockï¼Œæ²¡æœ‰è°ƒç”¨Copy æˆ–è€…ä¸åœ¨æ ˆä¸Šï¼Œé‚£ä¹ˆè¯¥å¯¹è±¡å‡ºä½œç”¨åŸŸå°±ä¼šè¢«é‡Šæ”¾ã€‚</li>
<li>å¦‚æœè°ƒç”¨å¯¹è±¡çš„Blockï¼Œè°ƒç”¨äº†Copyï¼Œæˆ–è€…Blockåœ¨å †ä¸Šï¼Œé‚£ä¹ˆè¯¥å¯¹è±¡çš„ä½œç”¨åŸŸè·Ÿä½¿ç”¨__blockä¿®é¥°çš„å˜é‡çš„ä½œç”¨åŸŸä¸€ç›´ï¼Œéƒ½ä¼šè¢«Blockæ‰€æŒæœ‰ï¼Œå¹¶ä¸”ç”Ÿå‘½å‘¨æœŸï¼Œä¼šéšç€Blockçš„åºŸé™¤ï¼Œè€Œé‡Šæ”¾ã€‚</li>
</ul>
<p>å› æ­¤å½“Blockä¸­ä½¿ç”¨å¯¹è±¡ç±»å‹çš„è‡ªåŠ¨å˜é‡æ—¶ï¼Œé™¤ä»¥ä¸‹æƒ…å½¢å¤–ï¼Œæ¨èè°ƒç”¨Blockçš„copyå®ä¾‹æ–¹æ³•ï¼ï¼</p>
<ul>
<li>blockä½œä¸ºå‡½æ•°è¿”å›å€¼è¿”å›æ—¶ã€‚</li>
<li>Blockèµ‹å€¼ç»™ç±»çš„é™„åŠ __strongä¿®é¥°ç¬¦çš„idç±»å‹æˆ–è€…Blockç±»å‹çš„æˆå‘˜å˜é‡æ—¶ã€‚</li>
<li>å‘æ–¹æ³•åä¸­å«æœ‰usingBlockçš„Cocoaæ¡†æ¶æ–¹æ³•æˆ–è€…GCDçš„APIä¸­ä¼ é€’Blockæ—¶ã€‚</li>
</ul>
<h4 id="blockå˜é‡å’Œå¯¹è±¡"><a href="#blockå˜é‡å’Œå¯¹è±¡" class="headerlink" title="__blockå˜é‡å’Œå¯¹è±¡"></a>__blockå˜é‡å’Œå¯¹è±¡</h4><p>ä»å‰é¢æˆ‘ä»¬çœ‹åˆ°__blockå¯ä»¥ä¿®é¥°ä»»æ„ç±»å‹ï¼š</p>
<ul>
<li>å½“ç„¶åŒ…æ‹¬idå¯¹è±¡<strong>strongç±»å‹äº†ï¼Œå…¶åŸç†æ˜¯ç›¸åŒçš„ï¼š<br> å½“ block ä»æ ˆä¸Šå¤åˆ¶åˆ° å †ä¸Šæ—¶ï¼Œ</strong>block æ‰€ä¿®é¥°çš„è‡ªåŠ¨å˜é‡ä¹Ÿä¼šä»æ ˆä¸Šå¤åˆ¶åˆ°å †ä¸Šï¼Œä½¿ç”¨_Block_objct_assignå‡½æ•°ï¼ŒæŒæœ‰èµ‹å€¼ç»™<strong>blockå˜é‡çš„å¯¹è±¡ã€‚å½“ block åºŸå¼ƒæ—¶ï¼Œ</strong>blockæ‰€ä¿®é¥°çš„è‡ªåŠ¨å˜é‡ï¼Œä¹Ÿä¼šé€šè¿‡å‡½æ•°_Block_objct_dispose ï¼Œé‡Šæ”¾æ‰__blockå˜é‡çš„å¯¹è±¡ã€‚</li>
<li>å½“<strong>weakä¿®é¥°ç¬¦ä¿®é¥°æ—¶ï¼Œç”±äº</strong>weakä¿®é¥°çš„è‡ªåŠ¨å˜é‡å‡ºä½œç”¨åŸŸåä¼šåºŸå¼ƒ è‡ªåŠ¨ç½®nilï¼Œæ‰€ä»¥å½“blockè°ƒç”¨çš„æ—¶å€™ï¼Œå…¶å®æ˜¯è°ƒç”¨çš„nilå¯¹è±¡æ‰€ä»¥ä¸ä¼šå´©æºƒï¼Œä½†å–ä¸åˆ°å€¼ã€‚</li>
<li>å½“<strong>block </strong>weak åŒæ—¶ä¿®é¥°è‡ªåŠ¨å˜é‡æ—¶ï¼Œè¿˜æ˜¯å› ä¸º<strong>weakï¼ˆä¸æŒæœ‰å¯¹è±¡ï¼‰çš„åŸå› ï¼Œå½“ block ä»æ ˆä¸Šå¤åˆ¶åˆ°å †ä¸Šæ—¶ï¼Œ</strong>blockå˜é‡å¤åˆ¶åˆ°å †ä¸Šçš„æ˜¯ä¸€ä¸ªnilå€¼ï¼Œæ‰€ä»¥å¯¹è¯¥å˜é‡è¿›è¡Œçš„æ“ä½œéƒ½æ˜¯æ— æ•ˆçš„ã€‚</li>
<li>å½“<strong>block å’Œ </strong>unsafe<strong>unretained  åŒæ—¶ä¿®é¥°å˜é‡æ—¶ï¼Œè·Ÿ</strong>weakä¸åŒï¼Œå½“<strong>unsafe</strong>unretainedï¼Œæ‰€ä¿®é¥°çš„å¯¹è±¡è¾¹nil æ—¶ è¯¥å˜é‡ä¸ä¼šè‡ªåŠ¨ç½®nilï¼Œè€Œæ˜¯å˜æˆé‡æŒ‡é’ˆï¼Œæ‰€ä»¥å½“block ä»æ ˆä¸Šå¤åˆ¶åˆ°å †ä¸Šæ—¶ï¼Œå®é™…ä¸Š__blockå˜é‡æ˜¯ä¸€ä¸ªé‡æŒ‡é’ˆï¼Œæ‰€ä»¥å½“è°ƒç”¨çš„æ—¶å€™å›å‡ºé”™ï¼Œå¯¼è‡´ç¨‹åºå´©æºƒ</li>
<li><strong>block å’Œ </strong>autoreleasing ä¿®é¥°è·Ÿ ä¸Šé¢çš„<strong>unsafe</strong>unretainedæ˜¯ä¸€æ ·çš„ã€‚</li>
</ul>
<h4 id="Block-å¾ªç¯å¼•ç”¨"><a href="#Block-å¾ªç¯å¼•ç”¨" class="headerlink" title="Block å¾ªç¯å¼•ç”¨"></a>Block å¾ªç¯å¼•ç”¨</h4><p>å­˜åœ¨å¾ªç¯å¼•ç”¨çš„æƒ…å†µï¼šå½“blockå¯¹è±¡ ä½œä¸ºç±»çš„ å±æ€§æˆ–è€…æˆå‘˜å˜é‡ï¼Œå¹¶ä¸”åœ¨blockåˆå§‹åŒ–çš„æ—¶å€™ï¼Œè°ƒç”¨äº†selfæˆ–è€…selfç›¸å…³ç±»çš„æˆå‘˜å˜é‡ã€‚éƒ½ä¼šå¼•èµ·å¼•ç”¨å¾ªç¯ã€‚</p>
<p>  è§£å†³æ–¹æ³•ï¼š</p>
<ul>
<li>ä½¿ç”¨__weak ä¿®é¥°è¦æˆªå–çš„è‡ªåŠ¨å˜é‡ï¼Œ</li>
<li>å½“åœ¨MRC ä¸­æ—¶ï¼Œå¯ä»¥ä½¿ç”¨__unsafe_unretainedï¼ˆå¼Šç«¯ ä¸ä¼šè‡ªåŠ¨ç½®nil å®¹æ˜“å‡ºç°é‡æŒ‡é’ˆï¼‰ ä¿®é¥°ã€‚</li>
<li>å¯ä»¥ä½¿ç”¨<strong>block ä¿®é¥°ï¼Œå‰ææ˜¯ å¿…é¡» æ‰§è¡Œblockä»£ç å—ï¼Œè€Œä¸”å¯ä»¥é€‚å½“åœ°åœ¨ä»£ç å—ä¸­ æ‰‹åŠ¨çš„æŠŠ</strong>blockå˜é‡ç½®nil<br>ä»¥ä¸‹æ˜¯ç›¸å…³è§£å†³æ–¹æ³•çš„å®ä¾‹ï¼š<br>å®ä¾‹ä¸€ï¼š</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">	typedef void (^blk_t)(void);</span><br><span class="line">	@interface Myobject : NSObject</span><br><span class="line">	&#123;</span><br><span class="line">		blk_t blk_; //æˆå‘˜å˜é‡</span><br><span class="line">		id _objc;//æˆå‘˜å˜é‡</span><br><span class="line">	&#125;</span><br><span class="line">	@end</span><br><span class="line">	@implementation MyObject</span><br><span class="line">	- (id)init</span><br><span class="line">	&#123;</span><br><span class="line">		self = [super init];</span><br><span class="line">		/*</span><br><span class="line">			åˆ†ææ”¹ä»£ç ä¼šå‡ºç°ä¸¤ç§æƒ…å†µçš„å¼•ç”¨å¾ªç¯ï¼š</span><br><span class="line">			 * ä¸€ç§æ˜¯ï¼šæˆå‘˜å˜é‡block è°ƒç”¨ selfï¼Œselfä¸­æŒæœ‰block ï¼Œblockä¸­ä¹ŸæŒæœ‰selfï¼Œå¯¼è‡´å¼•ç”¨å¾ªç¯ï¼Œè§£å†³æ–¹æ³•åœ¨ä¹‹å‰ åŠ å…¥</span><br><span class="line">			 __weak typeof(self) weakSelf = self;</span><br><span class="line">			 * ç¬¬äºŒä¸­ï¼Œè™½ç„¶æˆå‘˜å˜é‡blockæ²¡æœ‰ç›´æ¥è°ƒç”¨self ï¼Œä½†å…¶è°ƒç”¨äº†æˆå‘˜å˜é‡_objcï¼Œæ‰€ä»¥ä¹Ÿä¼šé€ æˆå¼•ç”¨å¾ªç¯:</span><br><span class="line">			 è§£å†³æ–¹æ³•ï¼š __weak id weakObjc = _objc;</span><br><span class="line">		*/</span><br><span class="line">		blk_ = ^&#123;</span><br><span class="line">			NSLog(@"self = %@, objc = %@",self,_objc);</span><br><span class="line">		&#125;	</span><br><span class="line">		return self;</span><br><span class="line">	&#125;</span><br><span class="line">``` </span><br><span class="line">å®ä¾‹äºŒï¼š</span><br><span class="line"></span><br><span class="line">``` objc</span><br><span class="line">	typedef void (^blk_t)(void);</span><br><span class="line">	@interface Myobject : NSObject</span><br><span class="line">	&#123;</span><br><span class="line">		blk_t blk_; //æˆå‘˜å˜é‡</span><br><span class="line">	&#125;</span><br><span class="line">	@end</span><br><span class="line">	@implementation MyObject</span><br><span class="line">	- (id)init</span><br><span class="line">	&#123;</span><br><span class="line">		self = [super init];</span><br><span class="line">		/*</span><br><span class="line">			æ­¤å¤„ä½¿ç”¨__blockä¿®é¥°å˜é‡ï¼Œæ˜¯çš„block æŒæœ‰__blockå˜é‡ï¼Œè€Œ__blockå˜é‡æŒæœ‰MyObjectå¯¹è±¡ï¼Œè€ŒMyObjectæŒæœ‰blockå¯¹è±¡ã€‚å‡ºç°å¼•ç”¨å¾ªç¯ï¼š</span><br><span class="line">			ç„¶è€Œ å½“ blockæ‰§è¡Œçš„æ—¶å€™ï¼Œ__blockå˜é‡åºŸå¼ƒï¼Œä»è€Œæ¶ˆé™¤å¼•ç”¨å¾ªç¯</span><br><span class="line">		*/</span><br><span class="line">	__block id temp = self;</span><br><span class="line">		blk_ = ^&#123;</span><br><span class="line">			NSLog(@"self = %@,,self);</span><br><span class="line">			temp = nil;</span><br><span class="line">		&#125;	</span><br><span class="line">		return self;</span><br><span class="line">	&#125;</span><br><span class="line">	- (void)execBlock</span><br><span class="line">	&#123;</span><br><span class="line">		blk_()</span><br><span class="line">	 &#125;</span><br><span class="line">	 int main ()&#123;</span><br><span class="line">		id o = [[MyObject alloc] init];</span><br><span class="line">		[o execBlock];//å¿…é¡»æ‰§è¡Œ å¦åˆ™å¯¼è‡´å¼•ç”¨å¾ªç¯</span><br><span class="line">		return 0;	 </span><br><span class="line">	 &#125;</span><br></pre></td></tr></table></figure>
<p>æ€»ç»“ä¸‹<strong>block å’Œ </strong>weak ä¹‹é—´çš„ä¼˜ç¼ºç‚¹ï¼š<br>    ä½¿ç”¨__blockå˜é‡çš„ä¼˜ç‚¹:</p>
<ul>
<li>é€šè¿‡__block å˜é‡å¯æ§åˆ¶å¯¹è±¡çš„æŒæœ‰æœŸé—´</li>
<li>åœ¨ä¸èƒ½ä½¿ç”¨<strong>weakä¿®é¥°ç¬¦çš„ç¯å¢ƒä¸­ä¸ä½¿ç”¨</strong>unsafe__unretainä¿®é¥°ç¬¦å³å¯ï¼ˆä¸å¿…æ‹…å¿ƒé‡æŒ‡é’ˆï¼‰<pre><code>åœ¨æ‰§è¡ŒBlockæ—¶å¯åŠ¨æ€çš„å†³å®šæ˜¯å¦å°†nilæˆ–è€…å…¶ä»–å¯¹è±¡èµ‹å€¼åœ¨__blockå˜é‡ä¸­ã€‚
</code></pre></li>
</ul>
<p>ä½¿ç”¨__blockå˜é‡çš„ç¼ºç‚¹å¦‚ä¸‹ï¼š</p>
<ul>
<li>ä¸ºé¿å…å¾ªç¯å¼•ç”¨å¿…é¡»æ‰§è¡ŒBlock</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Block/">Block</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-2016-03-12-read1" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/02/24/2016-03-12-read1/" class="article-date">
      <time datetime="2016-02-24T06:28:01.000Z" itemprop="datePublished">2016-02-24</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/24/2016-03-12-read1/">ã€iOSè¯»ä¹¦ç¬”è®°ç³»åˆ—ï¼ˆä¸€ï¼‰ã€‘</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h3 id="è¯»ä¹¦ç¬”è®°ï¼ˆä¸€ï¼‰"><a href="#è¯»ä¹¦ç¬”è®°ï¼ˆä¸€ï¼‰" class="headerlink" title="è¯»ä¹¦ç¬”è®°ï¼ˆä¸€ï¼‰"></a>è¯»ä¹¦ç¬”è®°ï¼ˆä¸€ï¼‰</h3><h4 id="ä¸€ã€instancetype-å’Œ-id-ä½œä¸ºåˆå§‹åŒ–å®ä¾‹-è¿”å›å€¼çš„ä¸åŒ"><a href="#ä¸€ã€instancetype-å’Œ-id-ä½œä¸ºåˆå§‹åŒ–å®ä¾‹-è¿”å›å€¼çš„ä¸åŒ" class="headerlink" title="ä¸€ã€instancetype å’Œ id ä½œä¸ºåˆå§‹åŒ–å®ä¾‹ è¿”å›å€¼çš„ä¸åŒ"></a>ä¸€ã€instancetype å’Œ id ä½œä¸ºåˆå§‹åŒ–å®ä¾‹ è¿”å›å€¼çš„ä¸åŒ</h4><p>Objective-Cçš„ä¸€äº›ä½¿ç”¨æƒ¯ä¾‹ä¸ä»…ä»…æ˜¯å¥½çš„ç¼–ç¨‹ä¹ æƒ¯ï¼Œæ›´æ˜¯ç»™ç¼–è¯‘å™¨çš„éšè—æŒ‡ä»¤ã€‚<br>ä¾‹å¦‚ï¼Œ alloc å’Œ init çš„è¿”å›ç±»å‹éƒ½æ˜¯ id ï¼Œç„¶è€Œåœ¨Xcodeä¸­ï¼Œç¼–è¯‘å™¨ä¼šæ£€æŸ¥æ‰€æœ‰æ­£ç¡®ç±»å‹ã€‚å®ƒæ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿ<br>åœ¨Cocoaä¸­ï¼Œçº¦å®š alloc æˆ– init çš„æ–¹æ³•æ€»æ˜¯è¿”å›æ¥æ”¶å™¨ç±»å®ä¾‹çš„å¯¹è±¡ã€‚æ®è¯´è¿™äº›æ–¹æ³•æœ‰ä¸€ä¸ªç›¸å…³è¿”å›ç±»å‹ã€‚<br>è™½ç„¶ç±»æ„é€ æ–¹æ³•ä¹Ÿæ˜¯è¿”å› id ï¼Œä½†æ˜¯ç±»æ„é€ æ–¹æ³•å¹¶æ²¡æœ‰åšåŒæ ·çš„ç±»å‹æ£€æŸ¥ï¼Œå› ä¸ºå®ƒä»¬ä¸éµå¾ªå‘½åè§„èŒƒã€‚<br>ä½ å¯ä»¥è‡ªå·±è¯•ç€è¿™æ ·ï¼š</p>
<pre><code>[[[NSArray alloc] init] mediaPlaybackAllowsAirPlay]; // â— &quot;No visible @interface for `NSArray` declares the selector `mediaPlaybackAllowsAirPlay`&quot;

[[NSArray array] mediaPlaybackAllowsAirPlay]; // (No error)
</code></pre><p>ç”±äºalloc å’Œ init ä½œä¸ºç›¸å…³è¿”å›ç±»å‹éµå¾ªå‘½åè§„èŒƒï¼Œæ‰§è¡Œå¯¹NSArrayçš„æ­£ç¡®ç±»å‹æ£€æŸ¥ã€‚ç„¶è€Œï¼Œç­‰ä»·ç±»æ„é€ å‡½æ•°arrayä¸éµå¾ªå‘½åè§„èŒƒï¼Œå®ƒè¢«è®¤ä¸ºæ˜¯idç±»å‹ã€‚<br>idç±»å‹å¯¹ç¦ç”¨ç±»å‹å®‰å…¨æ€§æ£€æŸ¥éå¸¸æœ‰ç”¨ï¼Œä½†å½“ä½ ç¡®å®éœ€è¦å®ƒçš„æ—¶å€™å´æ²¡æœ‰æ—¶ï¼Œæƒ…å†µä¼šå˜å¾—éå¸¸ç³Ÿç³•ã€‚<br>å¦ä¸€ç§æ˜¾ç¤ºå£°æ˜è¿”å›ç±»å‹ï¼ˆåœ¨ä¹‹å‰ä¾‹å­ä¸­çš„ (NSArray *)ï¼‰çš„æ–¹å¼æœ‰äº†ç¨å¾®çš„æ”¹è¿›ï¼Œä½†æ˜¯å®ƒä¸åˆ©äºå­ç±»çš„å‘æŒ¥ã€‚<br>æ‰€ä»¥ç¼–è¯‘å™¨ä»è¿™é‡Œä»‹å…¥ä»¥è§£å†³Objective-Cç±»å‹ç³»ç»Ÿçš„è¿™ä¸ªæ°¸æ’è¾¹ç•Œæƒ…å†µï¼š<br>instancetype å…³é”®å­—ï¼Œå®ƒå¯ä»¥è¡¨ç¤ºä¸€ä¸ªæ–¹æ³•çš„ç›¸å…³è¿”å›ç±»å‹ã€‚ä¾‹å¦‚ï¼š</p>
<pre><code>@interface Person
+(instancetype)personWithName:(NSString *)name;
@end
</code></pre><ul>
<li>instancetype ä¸ id ä¸ä¸€æ ·, instancetype åªèƒ½åœ¨æ–¹æ³•å£°æ˜ä¸­ä½œä¸ºè¿”å›ç±»å‹ä½¿ç”¨ã€‚</li>
</ul>
<p>ä½¿ç”¨ instancetype ï¼Œç¼–è¯‘å™¨å°†æ­£ç¡®çš„æ¨æ–­å‡º +personWithName: æ˜¯ Person çš„ä¸€ä¸ªå®ä¾‹ã€‚<br>ä¸ºäº†åœ¨ä¸ä¹…çš„å°†æ¥ä½¿ç”¨ instancetype ï¼Œä½ å¯ä»¥åœ¨Foundationä¸­æŸ¥æ‰¾ç±»æ„é€ å‡½æ•°ã€‚ä¾‹å¦‚UICollectionViewLayoutAttributes å°±å·²ç»æ­£åœ¨ä½¿ç”¨ instancetype äº†ã€‚</p>
<h3 id="äºŒã€iOSä¸ºä»€ä¹ˆä¸è¦åœ¨initåˆå§‹åŒ–æ–¹æ³•é‡Œè°ƒç”¨self-view"><a href="#äºŒã€iOSä¸ºä»€ä¹ˆä¸è¦åœ¨initåˆå§‹åŒ–æ–¹æ³•é‡Œè°ƒç”¨self-view" class="headerlink" title="äºŒã€iOSä¸ºä»€ä¹ˆä¸è¦åœ¨initåˆå§‹åŒ–æ–¹æ³•é‡Œè°ƒç”¨self.view"></a>äºŒã€iOSä¸ºä»€ä¹ˆä¸è¦åœ¨initåˆå§‹åŒ–æ–¹æ³•é‡Œè°ƒç”¨self.view</h3><p>é¦–å…ˆ.å¦‚æœä½ è°ƒç”¨self.viewçš„æ—¶å€™,å°±ä¼šè°ƒç”¨viewçš„getteræ–¹æ³•, è¿™ä¸ªæ—¶å€™,viewæ˜¯ç©ºçš„,é‚£ä¹ˆç³»ç»Ÿå°±ä¼šè‡ªåŠ¨ç»™ä½ åˆ›å»ºä¸€ä¸ªview,ç„¶åå°±ä¼šè§¦å‘ViewDidLoadæ–¹æ³•.é‚£ä¹ˆè¿™ä¸ªæ—¶å€™,å¦‚æœä½ initæ–¹æ³•é‡Œæœ‰æ•°ç»„åˆå§‹åŒ–.ä½†æ˜¯ä½ è¿˜æ²¡èµ°åˆ°é‚£æ­¥,è€Œç›´æ¥å°±ç»™æ•°ç»„èµ‹å€¼äº†,é‚£ä¹ˆè¿™ä¸ªå€¼èµ‹å€¼ç»™äº†ä¸€ä¸ªä¸å­˜åœ¨çš„æ•°ç»„.è¿™æ ·å°±å®¹æ˜“å‡ºç°é”™è¯¯.æ‰€ä»¥,å°½é‡ä¸è¦åœ¨initæ–¹æ³•é‡Œå†™å¯è§†åŒ–æ§ä»¶çš„è¯­å¥.</p>
<h3 id="ä¸‰ã€å¿½ç•¥ç¼–è¯‘è­¦å‘Š"><a href="#ä¸‰ã€å¿½ç•¥ç¼–è¯‘è­¦å‘Š" class="headerlink" title="ä¸‰ã€å¿½ç•¥ç¼–è¯‘è­¦å‘Š"></a>ä¸‰ã€å¿½ç•¥ç¼–è¯‘è­¦å‘Š</h3><p>å¦‚æœä½ çŸ¥é“ä½ çš„ä»£ç ä¸ä¼šå¯¼è‡´å†…å­˜æ³„éœ²ï¼Œä½ å¯ä»¥é€šè¿‡åŠ å…¥è¿™äº›ä»£ç å¿½ç•¥è¿™äº›è­¦å‘Š</p>
<pre><code>#pragma clang diagnostic push
#pragma clang diagnostic ignored &quot;-Warc-performSelector-leaks&quot;

[myObj performSelector:mySelector withObject:name];

#pragma clang diagnostic pop
</code></pre><p>æ³¨æ„æˆ‘ä»¬æ˜¯å¦‚ä½•åœ¨ç›¸å…³ä»£ç ä¸Šä¸‹æ–‡ä¸­ç”¨ pragma åœç”¨ -Warc-performSelector-leaks æ£€æŸ¥çš„ã€‚è¿™ç¡®ä¿æˆ‘ä»¬æ²¡æœ‰å…¨å±€ç¦ç”¨ã€‚å¦‚æœå…¨å±€ç¦ç”¨ï¼Œå¯èƒ½ä¼šå¯¼è‡´é”™è¯¯ã€‚</p>
<p>ä½¿ç”¨ #pragma unused():å¿½ç•¥æ²¡ç”¨ä½¿ç”¨å˜é‡çš„ç¼–è¯‘è­¦å‘Š</p>
<pre><code>-(NSInteger)giveMeFive
{
    NSString *foo;
    #pragma unused (foo)

    return 5;
}
</code></pre><h3 id="å››ã€Blockçš„æ·±å…¥å­¦ä¹ "><a href="#å››ã€Blockçš„æ·±å…¥å­¦ä¹ " class="headerlink" title="å››ã€Blockçš„æ·±å…¥å­¦ä¹ "></a>å››ã€Blockçš„æ·±å…¥å­¦ä¹ </h3><h4 id="ä¸€äº›å…³é”®ç‚¹ï¼š"><a href="#ä¸€äº›å…³é”®ç‚¹ï¼š" class="headerlink" title="ä¸€äº›å…³é”®ç‚¹ï¼š"></a>ä¸€äº›å…³é”®ç‚¹ï¼š</h4><pre><code>block æ˜¯åœ¨æ ˆä¸Šåˆ›å»ºçš„
block å¯ä»¥å¤åˆ¶åˆ°å †ä¸Š
Blockä¼šæ•è·æ ˆä¸Šçš„å˜é‡(æˆ–æŒ‡é’ˆ)ï¼Œå°†å…¶å¤åˆ¶ä¸ºè‡ªå·±ç§æœ‰çš„const(å˜é‡)ã€‚
(å¦‚æœåœ¨Blockä¸­ä¿®æ”¹Blockå—å¤–çš„)æ ˆä¸Šçš„å˜é‡å’ŒæŒ‡é’ˆï¼Œé‚£ä¹ˆè¿™äº›å˜é‡å’ŒæŒ‡é’ˆå¿…é¡»ç”¨__blockå…³é”®å­—ç”³æ˜(è¯‘è€…æ³¨ï¼šå¦åˆ™å°±ä¼šè·Ÿä¸Šé¢çš„æƒ…å†µä¸€æ ·åªæ˜¯æ•è·ä»–ä»¬çš„ç¬æ—¶å€¼)ã€‚
block å¯ä»¥å£°æ˜æˆå…¨å±€é™æ€çš„
</code></pre><p>å¦‚æœ block æ²¡æœ‰åœ¨å…¶ä»–åœ°æ–¹è¢«ä¿æŒï¼Œé‚£ä¹ˆå®ƒä¼šéšç€æ ˆç”Ÿå­˜å¹¶ä¸”å½“æ ˆå¸§ï¼ˆstack frameï¼‰è¿”å›çš„æ—¶å€™æ¶ˆå¤±ã€‚ä»…å­˜åœ¨äºæ ˆä¸Šæ—¶ï¼Œblockå¯¹å¯¹è±¡è®¿é—®çš„å†…å­˜ç®¡ç†å’Œç”Ÿå‘½å‘¨æœŸæ²¡æœ‰ä»»ä½•å½±å“ã€‚</p>
<p>å¦‚æœ block éœ€è¦åœ¨æ ˆå¸§è¿”å›çš„æ—¶å€™å­˜åœ¨ï¼Œå®ƒä»¬éœ€è¦æ˜ç¡®åœ°è¢«å¤åˆ¶åˆ°å †ä¸Šï¼Œè¿™æ ·ï¼Œblock ä¼šåƒå…¶ä»– Cocoa å¯¹è±¡ä¸€æ ·å¢åŠ å¼•ç”¨è®¡æ•°ã€‚å½“å®ƒä»¬è¢«å¤åˆ¶çš„æ—¶å€™ï¼Œå®ƒä¼šå¸¦ç€å®ƒä»¬çš„æ•è·ä½œç”¨åŸŸä¸€èµ·ï¼Œretain ä»–ä»¬æ‰€æœ‰å¼•ç”¨çš„å¯¹è±¡ã€‚</p>
<p>å¦‚æœä¸€ä¸ª blockå¼•ç”¨äº†ä¸€ä¸ªæ ˆå˜é‡æˆ–æŒ‡é’ˆï¼Œé‚£ä¹ˆè¿™ä¸ªblockåˆå§‹åŒ–çš„æ—¶å€™ä¼šæ‹¥æœ‰è¿™ä¸ªå˜é‡æˆ–æŒ‡é’ˆçš„constå‰¯æœ¬ï¼Œæ‰€ä»¥(è¢«æ•è·ä¹‹åå†åœ¨æ ˆä¸­æ”¹å˜è¿™ä¸ªå˜é‡æˆ–æŒ‡é’ˆçš„å€¼)æ˜¯ä¸èµ·ä½œç”¨çš„ã€‚(è¯‘è€…æ³¨ï¼šæ‰€ä»¥è¿™æ—¶å€™æˆ‘ä»¬åœ¨blockä¸­å¯¹è¿™ç§å˜é‡è¿›è¡Œèµ‹å€¼ä¼šç¼–è¯‘æŠ¥é”™:Variable is not assignable(missing __block type specifier)ï¼Œå› ä¸ºä»–ä»¬æ˜¯å‰¯æœ¬è€Œä¸”æ˜¯constçš„.å…·ä½“è§ä¸‹é¢çš„ä¾‹ç¨‹)ã€‚</p>
<p>å½“ä¸€ä¸ª block è¢«å¤åˆ¶åï¼Œ__block å£°æ˜çš„æ ˆå˜é‡çš„å¼•ç”¨è¢«å¤åˆ¶åˆ°äº†å †é‡Œï¼Œå¤åˆ¶å®Œæˆä¹‹åï¼Œæ— è®ºæ˜¯æ ˆä¸Šçš„blockè¿˜æ˜¯åˆšåˆšäº§ç”Ÿåœ¨å †ä¸Šçš„block(æ ˆä¸Šblockçš„å‰¯æœ¬)éƒ½ä¼šå¼•ç”¨è¯¥å˜é‡åœ¨å †ä¸Šçš„å‰¯æœ¬ã€‚</p>
<p>(ä¸‹é¢ä»£ç æ˜¯è¯‘è€…åŠ çš„)</p>
<pre><code>...
CGFloat blockInt = 10;
void (^playblock)(void) = ^{
    NSLog(@&quot;blockInt = %zd&quot;, blockInt);
};
blockInt ++;
playblock();
...

//ç»“æœä¸º:blockInt = 10
</code></pre><p>æœ€é‡è¦çš„äº‹æƒ…æ˜¯ __block å£°æ˜çš„å˜é‡å’ŒæŒ‡é’ˆåœ¨ block é‡Œé¢æ˜¯ä½œä¸ºæ˜¾ç¤ºæ“ä½œçœŸå®å€¼/å¯¹è±¡çš„ç»“æ„æ¥å¯¹å¾…çš„ã€‚</p>
<p>block åœ¨ Objective-C çš„ runtime(è¿è¡Œæ—¶) é‡Œé¢è¢«å½“ä½œä¸€ç­‰å…¬æ°‘å¯¹å¾…ï¼šä»–ä»¬æœ‰ä¸€ä¸ª isa æŒ‡é’ˆï¼Œä¸€ä¸ªç±»ä¹Ÿæ˜¯ç”¨ isa æŒ‡é’ˆåœ¨Objective-C è¿è¡Œæ—¶æ¥è®¿é—®æ–¹æ³•å’Œå­˜å‚¨æ•°æ®çš„ã€‚åœ¨é ARC ç¯å¢ƒè‚¯å®šä¼šæŠŠå®ƒæå¾—å¾ˆç³Ÿç³•ï¼Œå¹¶ä¸”æ‚¬æŒ‚æŒ‡é’ˆä¼šå¯¼è‡´ crashã€‚__block ä»…ä»…å¯¹ block å†…çš„å˜é‡èµ·ä½œç”¨ï¼Œå®ƒåªæ˜¯ç®€å•åœ°å‘Šè¯‰ blockï¼š</p>
<pre><code>å—¨ï¼Œè¿™ä¸ªæŒ‡é’ˆæˆ–è€…åŸå§‹çš„ç±»å‹ä¾èµ–å®ƒä»¬åœ¨çš„æ ˆã€‚è¯·ç”¨ä¸€ä¸ªæ ˆä¸Šçš„æ–°å˜é‡æ¥å¼•ç”¨å®ƒã€‚æˆ‘æ˜¯è¯´ï¼Œè¯·å¯¹å®ƒè¿›è¡ŒåŒé‡è§£å¼•ç”¨ï¼Œä¸è¦ retain å®ƒã€‚ è°¢è°¢ï¼Œå“¥ä»¬ã€‚
</code></pre><p>å¦‚æœåœ¨å®šä¹‰ä¹‹åä½†æ˜¯ block æ²¡æœ‰è¢«è°ƒç”¨å‰ï¼Œå¯¹è±¡è¢«é‡Šæ”¾äº†ï¼Œé‚£ä¹ˆ block çš„æ‰§è¡Œä¼šå¯¼è‡´ crashã€‚ __block å˜é‡ä¸ä¼šåœ¨ block ä¸­è¢«æŒæœ‰ï¼Œæœ€åâ€¦ æŒ‡é’ˆã€å¼•ç”¨ã€è§£å¼•ç”¨ä»¥åŠå¼•ç”¨è®¡æ•°å˜å¾—ä¸€å›¢ç³Ÿã€‚</p>
<h4 id="self-çš„å¾ªç¯å¼•ç”¨"><a href="#self-çš„å¾ªç¯å¼•ç”¨" class="headerlink" title="self çš„å¾ªç¯å¼•ç”¨"></a>self çš„å¾ªç¯å¼•ç”¨</h4><p>å½“ä½¿ç”¨ä»£ç å—å’Œå¼‚æ­¥åˆ†å‘çš„æ—¶å€™ï¼Œè¦æ³¨æ„é¿å…å¼•ç”¨å¾ªç¯ã€‚ æ€»æ˜¯ä½¿ç”¨ weak æ¥å¼•ç”¨å¯¹è±¡ï¼Œé¿å…å¼•ç”¨å¾ªç¯ã€‚ï¼ˆè¯‘è€…æ³¨ï¼šè¿™é‡Œæ›´ä¸ºä¼˜é›…çš„æ–¹å¼æ˜¯é‡‡ç”¨å½±å­å˜é‡@weakify/@strongify è¿™é‡Œæœ‰æ›´ä¸ºè¯¦ç»†çš„è¯´æ˜ï¼‰ æ­¤å¤–ï¼ŒæŠŠæŒæœ‰ block çš„å±æ€§è®¾ç½®ä¸º nil (æ¯”å¦‚ self.completionBlock = nil) æ˜¯ä¸€ä¸ªå¥½çš„å®è·µã€‚å®ƒä¼šæ‰“ç ´ block æ•è·çš„ä½œç”¨åŸŸå¸¦æ¥çš„å¼•ç”¨å¾ªç¯ã€‚</p>
<p>ä¾‹å­:</p>
<pre><code>__weak __typeof(self) weakSelf = self;
[self executeBlock:^(NSData *data, NSError *error) {
    [weakSelf doSomethingWithData:data];
}];
</code></pre><p>ä¸è¦è¿™æ ·:</p>
<pre><code>[self executeBlock:^(NSData *data, NSError *error) {
    [self doSomethingWithData:data];
}];
</code></pre><p>å¤šä¸ªè¯­å¥çš„ä¾‹å­:</p>
<pre><code>__weak __typeof(self)weakSelf = self;
[self executeBlock:^(NSData *data, NSError *error) {
    __strong __typeof(weakSelf) strongSelf = weakSelf;
    if (strongSelf) {
        [strongSelf doSomethingWithData:data];
        [strongSelf doSomethingWithData:data];
    }
}];
</code></pre><p>ä¸è¦è¿™æ ·:</p>
<pre><code>__weak __typeof(self)weakSelf = self;
[self executeBlock:^(NSData *data, NSError *error) {
    [weakSelf doSomethingWithData:data];
    [weakSelf doSomethingWithData:data];
}];
</code></pre><p>ä½ åº”è¯¥æŠŠè¿™ä¸¤è¡Œä»£ç ä½œä¸º snippet åŠ åˆ° Xcode é‡Œé¢å¹¶ä¸”æ€»æ˜¯è¿™æ ·ä½¿ç”¨å®ƒä»¬ã€‚</p>
<pre><code>__weak __typeof(self)weakSelf = self;
__strong __typeof(weakSelf)strongSelf = weakSelf;
</code></pre><p>è¿™é‡Œæˆ‘ä»¬æ¥è®¨è®ºä¸‹ block é‡Œé¢çš„ self çš„ <strong>weak å’Œ </strong>strong é™å®šè¯çš„ä¸€äº›å¾®å¦™çš„åœ°æ–¹ã€‚ç®€è€Œè¨€ä¹‹ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒ self åœ¨ block é‡Œé¢çš„ä¸‰ç§ä¸åŒæƒ…å†µã€‚</p>
<pre><code>ç›´æ¥åœ¨ block é‡Œé¢ä½¿ç”¨å…³é”®è¯ self
åœ¨ block å¤–å®šä¹‰ä¸€ä¸ª __weak çš„ å¼•ç”¨åˆ° selfï¼Œå¹¶ä¸”åœ¨ block é‡Œé¢ä½¿ç”¨è¿™ä¸ªå¼±å¼•ç”¨
åœ¨ block å¤–å®šä¹‰ä¸€ä¸ª __weak çš„ å¼•ç”¨åˆ° selfï¼Œå¹¶åœ¨åœ¨ block å†…éƒ¨é€šè¿‡è¿™ä¸ªå¼±å¼•ç”¨å®šä¹‰ä¸€ä¸ª __strong çš„å¼•ç”¨ã€‚
</code></pre><p>æ–¹æ¡ˆ 1. ç›´æ¥åœ¨ block é‡Œé¢ä½¿ç”¨å…³é”®è¯ self</p>
<p>å¦‚æœæˆ‘ä»¬ç›´æ¥åœ¨ block é‡Œé¢ç”¨ self å…³é”®å­—ï¼Œå¯¹è±¡ä¼šåœ¨ block çš„å®šä¹‰æ—¶å€™è¢« retainï¼Œï¼ˆå®é™…ä¸Š block æ˜¯ copied ä½†æ˜¯ä¸ºäº†ç®€å•æˆ‘ä»¬å¯ä»¥å¿½ç•¥è¿™ä¸ªï¼‰ã€‚ä¸€ä¸ª const çš„å¯¹ self çš„å¼•ç”¨åœ¨ block é‡Œé¢æœ‰è‡ªå·±çš„ä½ç½®å¹¶ä¸”å®ƒä¼šå½±å“å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ã€‚å¦‚æœè¿™ä¸ªblockè¢«å…¶ä»–çš„ç±»ä½¿ç”¨å¹¶ä¸”(æˆ–è€…)å½¼æ­¤é—´ä¼ æ¥ä¼ å»ï¼Œæˆ‘ä»¬å¯èƒ½æƒ³è¦åœ¨ block ä¸­ä¿ç•™ selfï¼Œå°±åƒå…¶ä»–åœ¨ block ä¸­ä½¿ç”¨çš„å¯¹è±¡ä¸€æ ·. å› ä¸ºä»–ä»¬æ˜¯blockæ‰§è¡Œæ‰€éœ€è¦çš„.</p>
<pre><code>dispatch_block_t completionBlock = ^{
    NSLog(@&quot;%@&quot;, self);
}

MyViewController *myController = [[MyViewController alloc] init...];
[self presentViewController:myController
                animated:YES
                completion:completionHandler];
</code></pre><p>æ²¡å•¥å¤§ä¸äº†ã€‚ä½†æ˜¯å¦‚æœé€šè¿‡ä¸€ä¸ªå±æ€§ä¸­çš„ self ä¿ç•™ äº†è¿™ä¸ª blockï¼ˆå°±åƒä¸‹é¢çš„ä¾‹ç¨‹ä¸€æ ·ï¼‰,å¯¹è±¡( self )ä¿ç•™äº† block ä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿ</p>
<pre><code>self.completionHandler = ^{
    NSLog(@&quot;%@&quot;, self);
}

MyViewController *myController = [[MyViewController alloc] init...];
[self presentViewController:myController
                animated:YES
                completion:self.completionHandler];
</code></pre><p>è¿™å°±æ˜¯æœ‰åçš„ retain cycle, å¹¶ä¸”æˆ‘ä»¬é€šå¸¸åº”è¯¥é¿å…å®ƒã€‚è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬æ”¶åˆ° CLANG çš„è­¦å‘Šï¼š</p>
<pre><code>Capturing &apos;self&apos; strongly in this block is likely to lead to a retain cycle ï¼ˆåœ¨ block é‡Œé¢å‘ç°äº† `self` çš„å¼ºå¼•ç”¨ï¼Œå¯èƒ½ä¼šå¯¼è‡´å¾ªç¯å¼•ç”¨ï¼‰
</code></pre><p>æ‰€ä»¥ __weak å°±æœ‰ç”¨æ­¦ä¹‹åœ°äº†ã€‚</p>
<p>æ–¹æ¡ˆ 2. åœ¨ block å¤–å®šä¹‰ä¸€ä¸ª __weak çš„ å¼•ç”¨åˆ° selfï¼Œå¹¶ä¸”åœ¨ block é‡Œé¢ä½¿ç”¨è¿™ä¸ªå¼±å¼•ç”¨</p>
<p>è¿™æ ·ä¼šé¿å…å¾ªåå¼•ç”¨ï¼Œä¹Ÿæ˜¯é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬çš„blockä½œä¸ºç±»çš„å±æ€§è¢«self retain çš„æ—¶å€™ä¼šåšçš„ã€‚</p>
<pre><code>__weak typeof(self) weakSelf = self;
self.completionHandler = ^{
    NSLog(@&quot;%@&quot;, weakSelf);
};

MyViewController *myController = [[MyViewController alloc] init...];
[self presentViewController:myController
                animated:YES
                completion:self.completionHandler];
</code></pre><p>è¿™ä¸ªæƒ…å†µä¸‹ block æ²¡æœ‰ retain å¯¹è±¡å¹¶ä¸”å¯¹è±¡åœ¨å±æ€§é‡Œé¢ retain äº† block ã€‚æ‰€ä»¥è¿™æ ·æˆ‘ä»¬èƒ½ä¿è¯äº†å®‰å…¨çš„è®¿é—® selfã€‚ ä¸è¿‡ç³Ÿç³•çš„æ˜¯ï¼Œå®ƒå¯èƒ½è¢«è®¾ç½®æˆ nil çš„ã€‚é—®é¢˜æ˜¯ï¼šå¦‚ä½•è®© self åœ¨ block é‡Œé¢å®‰å…¨åœ°è¢«é”€æ¯ã€‚</p>
<p>è€ƒè™‘è¿™ä¹ˆä¸ªæƒ…å†µï¼šblock ä½œä¸ºå±æ€§(property)èµ‹å€¼çš„ç»“æœï¼Œä»ä¸€ä¸ªå¯¹è±¡è¢«å¤åˆ¶åˆ°å¦ä¸€ä¸ªå¯¹è±¡(å¦‚ myController)ï¼Œåœ¨è¿™ä¸ªå¤åˆ¶çš„ block æ‰§è¡Œä¹‹å‰ï¼Œå‰è€…ï¼ˆå³ä¹‹å‰çš„é‚£ä¸ªå¯¹è±¡ï¼‰å·²ç»è¢«è§£é™¤åˆ†é…ã€‚</p>
<p>ä¸‹é¢çš„æ›´æœ‰æ„æ€ã€‚</p>
<p>æ–¹æ¡ˆ 3. åœ¨ block å¤–å®šä¹‰ä¸€ä¸ª <strong>weak çš„ å¼•ç”¨åˆ° selfï¼Œå¹¶åœ¨åœ¨ block å†…éƒ¨é€šè¿‡è¿™ä¸ªå¼±å¼•ç”¨å®šä¹‰ä¸€ä¸ª </strong>strong çš„å¼•ç”¨</p>
<p>ä½ å¯èƒ½ä¼šæƒ³ï¼Œé¦–å…ˆï¼Œè¿™æ˜¯é¿å… retain cycle è­¦å‘Šçš„ä¸€ä¸ªæŠ€å·§ã€‚</p>
<p>è¿™ä¸æ˜¯é‡ç‚¹ï¼Œè¿™ä¸ª self çš„å¼ºå¼•ç”¨æ˜¯åœ¨block æ‰§è¡Œæ—¶ è¢«åˆ›å»ºçš„ï¼Œä½†æ˜¯å¦ä½¿ç”¨ self åœ¨ block å®šä¹‰æ—¶å°±å·²ç»å®šä¸‹æ¥äº†ï¼Œ å› æ­¤self (åœ¨blockæ‰§è¡Œæ—¶) ä¼šè¢« retain.</p>
<p>Apple æ–‡æ¡£ ä¸­è¡¨ç¤º â€œä¸ºäº† non-trivial cycles ï¼Œä½ åº”è¯¥è¿™æ ·â€ ï¼š</p>
<pre><code>MyViewController *myController = [[MyViewController alloc] init...];
// ...
MyViewController * __weak weakMyController = myController;
myController.completionHandler =  ^(NSInteger result) {
    MyViewController *strongMyController = weakMyController;
    if (strongMyController) {
        // ...
        [strongMyController dismissViewControllerAnimated:YES completion:nil];
        // ...
    }
    else {
        // Probably nothing...
    }
};
</code></pre><p>é¦–å…ˆï¼Œæˆ‘è§‰å¾—è¿™ä¸ªä¾‹å­çœ‹èµ·æ¥æ˜¯é”™è¯¯çš„ã€‚å¦‚æœ block æœ¬èº«åœ¨ completionHandler å±æ€§ä¸­è¢« retain äº†ï¼Œé‚£ä¹ˆ self å¦‚ä½•è¢« delloc å’Œåœ¨ block ä¹‹å¤–èµ‹å€¼ä¸º nil å‘¢? completionHandler å±æ€§å¯ä»¥è¢«å£°æ˜ä¸º assign æˆ–è€… unsafe_unretained çš„ï¼Œæ¥å…è®¸å¯¹è±¡åœ¨ block è¢«ä¼ é€’ä¹‹åè¢«é”€æ¯ã€‚</p>
<p>æˆ‘ä¸èƒ½ç†è§£è¿™æ ·åšçš„ç†ç”±ï¼Œå¦‚æœå…¶ä»–å¯¹è±¡éœ€è¦è¿™ä¸ªå¯¹è±¡ï¼ˆselfï¼‰ï¼Œblock è¢«ä¼ é€’çš„æ—¶å€™åº”è¯¥ retain å¯¹è±¡ï¼Œæ‰€ä»¥ block åº”è¯¥ä¸è¢«ä½œä¸ºå±æ€§å­˜å‚¨ã€‚è¿™ç§æƒ…å†µä¸‹ä¸åº”è¯¥ç”¨ <strong>weak/</strong>strong</p>
<p>æ€»ä¹‹ï¼Œå…¶ä»–æƒ…å†µä¸‹ï¼Œå¸Œæœ› weakSelf å˜æˆ nil çš„è¯ï¼Œå°±åƒç¬¬äºŒç§æƒ…å†µè§£é‡Šé‚£ä¹ˆå†™ï¼ˆåœ¨ block ä¹‹å¤–å®šä¹‰ä¸€ä¸ªå¼±åº”ç”¨å¹¶ä¸”åœ¨ block é‡Œé¢ä½¿ç”¨ï¼‰ã€‚</p>
<p>è¿˜æœ‰ï¼ŒAppleçš„ â€œtrivial blockâ€ æ˜¯ä»€ä¹ˆå‘¢ã€‚æˆ‘ä»¬çš„ç†è§£æ˜¯ trivial block æ˜¯ä¸€ä¸ªä¸è¢«ä¼ é€çš„ block ï¼Œå®ƒåœ¨ä¸€ä¸ªè‰¯å¥½å®šä¹‰å’Œæ§åˆ¶çš„ä½œç”¨åŸŸé‡Œé¢ï¼Œweak ä¿®é¥°åªæ˜¯ä¸ºäº†é¿å…å¾ªç¯å¼•ç”¨ã€‚</p>
<p>è™½ç„¶æœ‰ Kazuki Sakamoto å’Œ Tomohiko Furumoto) è®¨è®ºçš„ ä¸€ äº› çš„ åœ¨çº¿ å‚è€ƒ, Matt Galloway çš„ (Effective Objective-C 2.0 å’Œ Pro Multithreading and Memory Management for iOS and OS X ï¼Œå¤§å¤šæ•°å¼€å‘è€…å§‹ç»ˆæ²¡æœ‰å¼„æ¸…æ¥šæ¦‚å¿µã€‚</p>
<p>åœ¨ block å†…ç”¨å¼ºå¼•ç”¨çš„ä¼˜ç‚¹æ˜¯ï¼ŒæŠ¢å æ‰§è¡Œçš„æ—¶å€™çš„é²æ£’æ€§ã€‚åœ¨ block æ‰§è¡Œçš„æ—¶å€™, å†æ¬¡æ¸©æ•…ä¸‹ä¸Šé¢çš„ä¸‰ä¸ªä¾‹å­ï¼š</p>
<p>æ–¹æ¡ˆ 1. ç›´æ¥åœ¨ block é‡Œé¢ä½¿ç”¨å…³é”®è¯ self</p>
<p>å¦‚æœ block è¢«å±æ€§ retainï¼Œself å’Œ block ä¹‹é—´ä¼šæœ‰ä¸€ä¸ªå¾ªç¯å¼•ç”¨å¹¶ä¸”å®ƒä»¬ä¸ä¼šå†è¢«é‡Šæ”¾ã€‚å¦‚æœ block è¢«ä¼ é€å¹¶ä¸”è¢«å…¶ä»–çš„å¯¹è±¡ copy äº†ï¼Œself åœ¨æ¯ä¸€ä¸ª copy é‡Œé¢è¢« retain</p>
<p>æ–¹æ¡ˆ 2. åœ¨ block å¤–å®šä¹‰ä¸€ä¸ª __weak çš„ å¼•ç”¨åˆ° selfï¼Œå¹¶ä¸”åœ¨ block é‡Œé¢ä½¿ç”¨è¿™ä¸ªå¼±å¼•ç”¨</p>
<p>ä¸ç®¡ block æ˜¯å¦é€šè¿‡å±æ€§è¢« retain ï¼Œè¿™é‡Œéƒ½ä¸ä¼šå‘ç”Ÿå¾ªç¯å¼•ç”¨ã€‚å¦‚æœ block è¢«ä¼ é€’æˆ–è€… copy äº†ï¼Œåœ¨æ‰§è¡Œçš„æ—¶å€™ï¼ŒweakSelf å¯èƒ½å·²ç»å˜æˆ nilã€‚</p>
<p>block çš„æ‰§è¡Œå¯ä»¥æŠ¢å ï¼Œè€Œä¸”å¯¹ weakSelf æŒ‡é’ˆçš„è°ƒç”¨æ—¶åºä¸åŒå¯ä»¥å¯¼è‡´ä¸åŒçš„ç»“æœ(å¦‚ï¼šåœ¨ä¸€ä¸ªç‰¹å®šçš„æ—¶åºä¸‹ weakSelf å¯èƒ½ä¼šå˜æˆnil)ã€‚</p>
<pre><code>__weak typeof(self) weakSelf = self;
dispatch_block_t block =  ^{
    [weakSelf doSomething]; // weakSelf != nil
    // preemption, weakSelf turned nil
    [weakSelf doSomethingElse]; // weakSelf == nil
};
</code></pre><p>æ–¹æ¡ˆ 3. åœ¨ block å¤–å®šä¹‰ä¸€ä¸ª <strong>weak çš„ å¼•ç”¨åˆ° selfï¼Œå¹¶åœ¨åœ¨ block å†…éƒ¨é€šè¿‡è¿™ä¸ªå¼±å¼•ç”¨å®šä¹‰ä¸€ä¸ª </strong>strong çš„å¼•ç”¨ã€‚</p>
<p>ä¸ç®¡ block æ˜¯å¦é€šè¿‡å±æ€§è¢« retain ï¼Œè¿™é‡Œä¹Ÿä¸ä¼šå‘ç”Ÿå¾ªç¯å¼•ç”¨ã€‚å¦‚æœ block è¢«ä¼ é€’åˆ°å…¶ä»–å¯¹è±¡å¹¶ä¸”è¢«å¤åˆ¶äº†ï¼Œæ‰§è¡Œçš„æ—¶å€™ï¼ŒweakSelf å¯èƒ½è¢«nilï¼Œå› ä¸ºå¼ºå¼•ç”¨è¢«èµ‹å€¼å¹¶ä¸”ä¸ä¼šå˜æˆnilçš„æ—¶å€™ï¼Œæˆ‘ä»¬ç¡®ä¿å¯¹è±¡ åœ¨ block è°ƒç”¨çš„å®Œæ•´å‘¨æœŸé‡Œé¢è¢« retainäº†ï¼Œå¦‚æœæŠ¢å å‘ç”Ÿäº†ï¼Œéšåçš„å¯¹ strongSelf çš„æ‰§è¡Œä¼šç»§ç»­å¹¶ä¸”ä¼šäº§ç”Ÿä¸€æ ·çš„å€¼ã€‚å¦‚æœ strongSelf çš„æ‰§è¡Œåˆ° nilï¼Œé‚£ä¹ˆåœ¨ block ä¸èƒ½æ­£ç¡®æ‰§è¡Œå‰å·²ç»è¿”å›äº†ã€‚</p>
<pre><code>__weak typeof(self) weakSelf = self;
myObj.myBlock =  ^{
    __strong typeof(self) strongSelf = weakSelf;
    if (strongSelf) {
    [strongSelf doSomething]; // strongSelf != nil
    // preemption, strongSelf still not nilï¼ˆæŠ¢å çš„æ—¶å€™ï¼ŒstrongSelf è¿˜æ˜¯é nil çš„)
    [strongSelf doSomethingElse]; // strongSelf != nil
    }
    else {
        // Probably nothing...
        return;
    }
};
</code></pre><p>åœ¨ARCæ¡ä»¶ä¸­ï¼Œå¦‚æœå°è¯•ç”¨ -&gt; ç¬¦å·è®¿é—®ä¸€ä¸ªå®ä¾‹å˜é‡ï¼Œç¼–è¯‘å™¨ä¼šç»™å‡ºéå¸¸æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯ï¼š</p>
<p>Dereferencing a <strong>weak pointer is not allowed due to possible null value caused by race condition, assign it to a strong variable first. (å¯¹ä¸€ä¸ª </strong>weak æŒ‡é’ˆçš„è§£å¼•ç”¨ä¸å…è®¸çš„ï¼Œå› ä¸ºå¯èƒ½åœ¨ç«æ€æ¡ä»¶é‡Œé¢å˜æˆ null, æ‰€ä»¥å…ˆæŠŠä»–å®šä¹‰æˆ strong çš„å±æ€§)</p>
<p>å¯ä»¥ç”¨ä¸‹é¢çš„ä»£ç å±•ç¤º</p>
<pre><code>__weak typeof(self) weakSelf = self;
myObj.myBlock =  ^{
    id localVal = weakSelf-&gt;someIVar;
};
</code></pre><p>åœ¨æœ€å</p>
<pre><code>æ–¹æ¡ˆ 1: åªèƒ½åœ¨ block ä¸æ˜¯ä½œä¸ºä¸€ä¸ª property çš„æ—¶å€™ä½¿ç”¨ï¼Œå¦åˆ™ä¼šå¯¼è‡´ retain cycleã€‚

æ–¹æ¡ˆ 2: å½“ block è¢«å£°æ˜ä¸ºä¸€ä¸ª property çš„æ—¶å€™ä½¿ç”¨ã€‚

æ–¹æ¡ˆ 3: å’Œå¹¶å‘æ‰§è¡Œæœ‰å…³ã€‚å½“æ¶‰åŠå¼‚æ­¥çš„æœåŠ¡çš„æ—¶å€™ï¼Œblock å¯ä»¥åœ¨ä¹‹åè¢«æ‰§è¡Œï¼Œå¹¶ä¸”ä¸ä¼šå‘ç”Ÿå…³äº self æ˜¯å¦å­˜åœ¨çš„é—®é¢˜ã€‚
</code></pre><h3 id="äº”ã€IOSé«˜æ•ˆæ·»åŠ åœ†è§’æ•ˆæœ"><a href="#äº”ã€IOSé«˜æ•ˆæ·»åŠ åœ†è§’æ•ˆæœ" class="headerlink" title="äº”ã€IOSé«˜æ•ˆæ·»åŠ åœ†è§’æ•ˆæœ"></a>äº”ã€IOSé«˜æ•ˆæ·»åŠ åœ†è§’æ•ˆæœ</h3><p>è¯¯åŒºä¸€ï¼š</p>
<pre><code>view.layer.cornerRadius = 5
</code></pre><p>è¯¥ä»£ç ç»è¿‡æµ‹è¯•æ˜¯ä¸ä¼šé€ æˆå†…å­˜æ€§èƒ½æŸè€—ã€‚</p>
<pre><code>view.layer.masksToBounds = Yes // é®ç½©layerå±‚ä»¥ä¸‹çš„è§†
å›¾ï¼Œä½¿åœ†è§’ç”Ÿæ•ˆ
</code></pre><p>è¿™ä»£ç æ‰æ˜¯é€ æˆæ€§èƒ½æŸè€—çš„å…³é”®å› ç´ ã€‚ç”±äºè¯¥ä»£ç ä¼šå¯¼è‡´è§†å›¾ç¦»å±æ¸²æŸ“ï¼ˆColor Offscreen-Renderd Yellowï¼‰ç›¸å…³æ–‡ç« :<a href="http://www.jianshu.com/p/619cf14640f3" target="_blank" rel="external">UIKitæ€§èƒ½è°ƒä¼˜å®æˆ˜è®²è§£</a></p>
<p>æ³¨æ„äº‹é¡¹ï¼šæˆ‘ä»¬åº”è¯¥å°½é‡é¿å…é‡å†™ drawRect æ–¹æ³•ï¼Œç”¨CAShapeLayerä»£æ›¿å›¾å±‚ç»˜åˆ¶ã€‚ä¸æ°å½“çš„ä½¿ç”¨è¿™ä¸ªæ–¹æ³•</p>
<p>ä¼šå¯¼è‡´å†…å­˜æš´å¢ã€‚ä¸¾ä¸ªä¾‹å­ï¼ŒiPhone6 ä¸Šä¸å±å¹•ç­‰å¤§çš„ UIViewï¼Œå³ä½¿é‡å†™ä¸€ä¸ªç©ºçš„ drawRect æ–¹æ³•ï¼Œå®ƒä¹Ÿ</p>
<p>è‡³å°‘å ç”¨ 750 <em> 1134 </em> 4 å­—èŠ‚ â‰ˆ 3.4 Mb çš„å†…å­˜ã€‚åœ¨å†…å­˜æ¶é¬¼drawRect åŠå…¶åç»­ä¸­ï¼Œä½œè€…è¯¦ç»†ä»‹ç»äº†</p>
<p>å…¶ä¸­åŸç†ï¼Œæ®ä»–æµ‹è¯•ï¼Œåœ¨ iPhone6 ä¸Šç©ºçš„ã€ä¸å±å¹•ç­‰å¤§çš„è§†å›¾é‡å†™ drawRect æ–¹æ³•ä¼šæ¶ˆè€— 5.2 Mb å†…å­˜ã€‚</p>
<p>æ€»ä¹‹ï¼Œèƒ½é¿å…é‡å†™ drawRect æ–¹æ³•å°±å°½å¯èƒ½é¿å…ã€‚</p>
<p>å…¶æ¬¡ï¼Œè¿™ç§æ–¹æ³•æœ¬è´¨ä¸Šæ˜¯ç”¨é®ç½©å±‚ mask æ¥å®ç°ï¼Œå› æ­¤åŒæ ·æ— å¯é¿å…çš„ä¼šå¯¼è‡´ç¦»å±æ¸²æŸ“ã€‚æˆ‘è¯•ç€å°†æ­¤å‰ 34 ä¸ª</p>
<p>è§†å›¾çš„åœ†è§’æ”¹ç”¨è¿™ç§æ–¹æ³•å®ç°ï¼Œç»“æœ fps æ‰åˆ° 11 å·¦å³ã€‚å·²ç»å±äºå¡å‡ºç¿”çš„èŠ‚å¥äº†ã€‚</p>
<p>é«˜æ•ˆè®¾ç½®åœ†è§’å®æˆ˜ï¼š</p>
<h4 id="ä¸º-UIView-æ·»åŠ åœ†è§’"><a href="#ä¸º-UIView-æ·»åŠ åœ†è§’" class="headerlink" title="ä¸º UIView æ·»åŠ åœ†è§’"></a>ä¸º UIView æ·»åŠ åœ†è§’</h4><p>è¿™ç§åšæ³•çš„åŸç†æ˜¯æ‰‹åŠ¨ç”»å‡ºåœ†è§’ã€‚è™½ç„¶æˆ‘ä»¬ä¹‹å‰è¯´è¿‡ï¼Œä¸ºæ™®é€šçš„è§†å›¾ç›´æ¥è®¾ç½® cornerRadius å±æ€§å³å¯ã€‚ä½†ä¸‡ä¸€ä¸å¯é¿å…çš„éœ€è¦ä½¿ç”¨ masksToBoundsï¼Œå°±å¯ä»¥ä½¿ç”¨ä¸‹é¢è¿™ç§æ–¹æ³•ï¼Œå®ƒçš„æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">func kt_drawRectWithRoundedCorner(radius radius: <span class="built_in">CGFloat</span>,       </span><br><span class="line">                       borderWidth: <span class="built_in">CGFloat</span>,</span><br><span class="line">                                  backgroundColor: <span class="built_in">UIColor</span>,</span><br><span class="line">                                  borderColor: <span class="built_in">UIColor</span>) -&gt; <span class="built_in">UIImage</span> &#123;    </span><br><span class="line">     <span class="built_in">UIGraphicsBeginImageContextWithOptions</span>(sizeToFit, <span class="literal">false</span>, <span class="built_in">UIScreen</span>.mainScreen().scale)</span><br><span class="line">     let context = <span class="built_in">UIGraphicsGetCurrentContext</span>()</span><br><span class="line">     </span><br><span class="line">     <span class="built_in">CGContextMoveToPoint</span>(context, å¼€å§‹ä½ç½®);  <span class="comment">// å¼€å§‹åæ ‡å³è¾¹å¼€å§‹</span></span><br><span class="line">     <span class="built_in">CGContextAddArcToPoint</span>(context, x1, y1, x2, y2, radius);  <span class="comment">// è¿™ç§ç±»å‹çš„ä»£ç é‡å¤å››æ¬¡</span></span><br><span class="line">   </span><br><span class="line">     <span class="built_in">CGContextDrawPath</span>(<span class="built_in">UIGraphicsGetCurrentContext</span>(), .FillStroke)  </span><br><span class="line">     let output = <span class="built_in">UIGraphicsGetImageFromCurrentImageContext</span>();</span><br><span class="line">     <span class="built_in">UIGraphicsEndImageContext</span>();</span><br><span class="line">     <span class="keyword">return</span> output</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•è¿”å›çš„æ˜¯ UIImageï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åˆ©ç”¨ Core Graphics è‡ªå·±ç”»å‡ºäº†ä¸€ä¸ªåœ†è§’çŸ©å½¢ã€‚é™¤äº†ä¸€äº›å¿…è¦çš„ä»£ç å¤–ï¼Œæœ€æ ¸å¿ƒçš„å°±æ˜¯ CGContextAddArcToPoint å‡½æ•°ã€‚å®ƒä¸­é—´çš„å››ä¸ªå‚æ•°è¡¨ç¤ºæ›²çº¿çš„èµ·ç‚¹å’Œç»ˆç‚¹åæ ‡ï¼Œæœ€åä¸€ä¸ªå‚æ•°è¡¨ç¤ºåŠå¾„ã€‚è°ƒç”¨äº†å››æ¬¡å‡½æ•°åï¼Œå°±å¯ä»¥ç”»å‡ºåœ†è§’çŸ©å½¢ã€‚æœ€åå†ä»å½“å‰çš„ç»˜å›¾ä¸Šä¸‹æ–‡ä¸­è·å–å›¾ç‰‡å¹¶è¿”å›ã€‚<br>æœ‰äº†è¿™ä¸ªå›¾ç‰‡åï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª UIImageView å¹¶æ’å…¥åˆ°è§†å›¾å±‚çº§çš„åº•éƒ¨ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">extension <span class="built_in">UIView</span> &#123;</span><br><span class="line">    func kt_addCorner(radius radius: <span class="built_in">CGFloat</span>,</span><br><span class="line">                      borderWidth: <span class="built_in">CGFloat</span>,</span><br><span class="line">                      backgroundColor: <span class="built_in">UIColor</span>,</span><br><span class="line">                      borderColor: <span class="built_in">UIColor</span>) &#123;</span><br><span class="line">        let imageView = <span class="built_in">UIImageView</span>(image: kt_drawRectWithRoundedCorner(radius: radius,</span><br><span class="line">                                    borderWidth: borderWidth,</span><br><span class="line">                                    backgroundColor: backgroundColor,</span><br><span class="line">                                    borderColor: borderColor))</span><br><span class="line">        <span class="keyword">self</span>.insertSubview(imageView, atIndex: <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®Œæ•´çš„ä»£ç å¯ä»¥åœ¨é¡¹ç›®ä¸­æ‰¾åˆ°ï¼Œä½¿ç”¨æ—¶ï¼Œä½ åªéœ€è¦è¿™æ ·å†™ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let view = <span class="built_in">UIView</span>(frame: <span class="built_in">CGRectMake</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>))</span><br><span class="line">view.kt_addCorner(radius: <span class="number">6</span>)</span><br></pre></td></tr></table></figure>
<h4 id="ä¸º-UIImageView-æ·»åŠ åœ†è§’"><a href="#ä¸º-UIImageView-æ·»åŠ åœ†è§’" class="headerlink" title="ä¸º UIImageView æ·»åŠ åœ†è§’"></a>ä¸º UIImageView æ·»åŠ åœ†è§’</h4><p>ç›¸æ¯”äºä¸Šé¢ä¸€ç§å®ç°æ–¹æ³•ï¼Œä¸º UIImageView æ·»åŠ åœ†è§’æ›´ä¸ºå¸¸ç”¨ã€‚å®ƒçš„å®ç°æ€è·¯æ˜¯ç›´æ¥æˆªå–å›¾ç‰‡ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">extension <span class="built_in">UIImage</span> &#123;</span><br><span class="line">    func kt_drawRectWithRoundedCorner(radius radius: <span class="built_in">CGFloat</span>, _ sizetoFit: <span class="built_in">CGSize</span>) -&gt; <span class="built_in">UIImage</span> &#123;</span><br><span class="line">        let rect = <span class="built_in">CGRect</span>(origin: <span class="built_in">CGPoint</span>(x: <span class="number">0</span>, y: <span class="number">0</span>), size: sizetoFit)</span><br><span class="line">         </span><br><span class="line">        <span class="built_in">UIGraphicsBeginImageContextWithOptions</span>(rect.size, <span class="literal">false</span>, <span class="built_in">UIScreen</span>.mainScreen().scale)</span><br><span class="line">        <span class="built_in">CGContextAddPath</span>(<span class="built_in">UIGraphicsGetCurrentContext</span>(),</span><br><span class="line">            <span class="built_in">UIBezierPath</span>(roundedRect: rect, byRoundingCorners: <span class="built_in">UIRectCorner</span>.AllCorners,</span><br><span class="line">                cornerRadii: <span class="built_in">CGSize</span>(width: radius, height: radius)).CGPath)</span><br><span class="line">        <span class="built_in">CGContextClip</span>(<span class="built_in">UIGraphicsGetCurrentContext</span>())</span><br><span class="line">         </span><br><span class="line">        <span class="keyword">self</span>.drawInRect(rect)</span><br><span class="line">        <span class="built_in">CGContextDrawPath</span>(<span class="built_in">UIGraphicsGetCurrentContext</span>(), .FillStroke)</span><br><span class="line">        let output = <span class="built_in">UIGraphicsGetImageFromCurrentImageContext</span>();</span><br><span class="line">        <span class="built_in">UIGraphicsEndImageContext</span>();</span><br><span class="line">         </span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">`</span><br></pre></td></tr></table></figure>
<p>åœ†è§’è·¯å¾„ç›´æ¥ç”¨è´å¡å°”æ›²çº¿ç»˜åˆ¶ï¼Œä¸€ä¸ªæ„å¤–çš„ bonus æ˜¯è¿˜å¯ä»¥é€‰æ‹©å“ªå‡ ä¸ªè§’æœ‰åœ†è§’æ•ˆæœã€‚è¿™ä¸ªå‡½æ•°çš„æ•ˆæœæ˜¯å°†åŸæ¥çš„ UIImage å‰ªè£å‡ºåœ†è§’ã€‚é…åˆç€è¿™å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ä¸º UIImageView æ‹“å±•ä¸€ä¸ªè®¾ç½®åœ†è§’çš„æ–¹æ³•ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">extension <span class="built_in">UIImageView</span> &#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     / !!!åªæœ‰å½“ imageView ä¸ä¸ºnil æ—¶ï¼Œè°ƒç”¨æ­¤æ–¹æ³•æ‰æœ‰æ•ˆæœ</span><br><span class="line">     :param: radius åœ†è§’åŠå¾„</span><br><span class="line">     */</span></span><br><span class="line">    override func kt_addCorner(radius radius: <span class="built_in">CGFloat</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.image = <span class="keyword">self</span>.image?.kt_drawRectWithRoundedCorner(radius: radius, <span class="keyword">self</span>.bounds.size)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®Œæ•´çš„ä»£ç å¯ä»¥åœ¨é¡¹ç›®ä¸­æ‰¾åˆ°ï¼Œä½¿ç”¨æ—¶ï¼Œä½ åªéœ€è¦è¿™æ ·å†™ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let imageView = let imgView1 = <span class="built_in">UIImageView</span>(image: <span class="built_in">UIImage</span>(name: <span class="string">""</span>))</span><br><span class="line">imageView.kt_addCorner(radius: <span class="number">6</span>)</span><br></pre></td></tr></table></figure>
<h3 id="å…­ã€UIKit-æ€§èƒ½ä¼˜åŒ–-è¯»åæ€»ç»“"><a href="#å…­ã€UIKit-æ€§èƒ½ä¼˜åŒ–-è¯»åæ€»ç»“" class="headerlink" title="å…­ã€UIKit æ€§èƒ½ä¼˜åŒ– è¯»åæ€»ç»“"></a>å…­ã€UIKit æ€§èƒ½ä¼˜åŒ– è¯»åæ€»ç»“</h3><p>åŸæ–‡åœ°å€ï¼š<a href="http://www.jianshu.com/p/619cf14640f3" target="_blank" rel="external">UIKitæ€§èƒ½è°ƒä¼˜å®æˆ˜è®²è§£</a></p>
<h4 id="é¦–é€‰æ¥è¯´-ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦è¿›è¡ŒUIKitä¼˜åŒ–ï¼Ÿ"><a href="#é¦–é€‰æ¥è¯´-ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦è¿›è¡ŒUIKitä¼˜åŒ–ï¼Ÿ" class="headerlink" title="é¦–é€‰æ¥è¯´ ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦è¿›è¡ŒUIKitä¼˜åŒ–ï¼Ÿ"></a>é¦–é€‰æ¥è¯´ ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦è¿›è¡ŒUIKitä¼˜åŒ–ï¼Ÿ</h4><p>ç›´æ¥ä¸Šå›¾ï¼š</p>
<p> <img src="../images/ç¬”è®°ä¸€/ios_frame_drop.png" alt="" title="Title"></p>
<p>å¦‚å›¾æ‰€ç¤ºï¼Œæ­£å¸¸æƒ…å†µå›¾å±‚çš„æ¸²æŸ“æ˜¯é€šè¿‡CPUçš„è®¡ç®—å’ŒGPUçš„å¤„ç†å®Œæˆ æ­£å¸¸çš„æ¸²æŸ“æµç¨‹çš„ã€‚</p>
<ul>
<li>å½“CPUå’ŒGPUçš„è€—æ—¶æ—¶é—´æ§åˆ¶åœ¨16.67msä¹‹é—´ï¼ˆå¦‚ç¬¬ä¸€éƒ¨åˆ†ï¼‰å›¾å±‚å°±ä¼šæ­£å¸¸æ¸²æŸ“ã€‚</li>
<li>å½“CPUå’ŒGPUçš„è€—æ—¶æ—¶é—´è¶…è¿‡äº†16.67msï¼ˆå¦‚ç¬¬äºŒéƒ¨åˆ†ï¼‰å›¾å±‚æ¸²æŸ“å°±ä¼šæ‰å¸§ï¼Œå³å±å¹•å°±ä¼šå‡ºç°èŠ±å±æˆ–è€…å¡é¡¿çš„ç°è±¡ã€‚<br>æ‰€ä»¥ï¼Œä¸ºäº†ä¿è¯å›¾å±‚çš„æ­£å¸¸æ¸²æŸ“ä»¥åŠæé«˜æ€§èƒ½ï¼Œæˆ‘ä»¬ç€é‡ä»ç¼“å‡CPU å’Œ GPU ä¸å¿…è¦çš„æ¶ˆè€—ä¸Šï¼Œæ¥åšä¼˜åŒ–å’Œè°ƒæ•´ã€‚</li>
</ul>
<h4 id="1-ä¸ºä»€ä¹ˆè¦æŠŠæ§ä»¶å°½é‡è®¾ç½®æˆä¸é€æ˜ï¼Œå¦‚æœæ˜¯é€æ˜çš„ä¼šæœ‰ä»€ä¹ˆå½±å“ï¼Œå¦‚ä½•æ£€æµ‹è¿™ç§å½±å“ï¼Ÿ"><a href="#1-ä¸ºä»€ä¹ˆè¦æŠŠæ§ä»¶å°½é‡è®¾ç½®æˆä¸é€æ˜ï¼Œå¦‚æœæ˜¯é€æ˜çš„ä¼šæœ‰ä»€ä¹ˆå½±å“ï¼Œå¦‚ä½•æ£€æµ‹è¿™ç§å½±å“ï¼Ÿ" class="headerlink" title="1.ä¸ºä»€ä¹ˆè¦æŠŠæ§ä»¶å°½é‡è®¾ç½®æˆä¸é€æ˜ï¼Œå¦‚æœæ˜¯é€æ˜çš„ä¼šæœ‰ä»€ä¹ˆå½±å“ï¼Œå¦‚ä½•æ£€æµ‹è¿™ç§å½±å“ï¼Ÿ"></a>1.ä¸ºä»€ä¹ˆè¦æŠŠæ§ä»¶å°½é‡è®¾ç½®æˆä¸é€æ˜ï¼Œå¦‚æœæ˜¯é€æ˜çš„ä¼šæœ‰ä»€ä¹ˆå½±å“ï¼Œå¦‚ä½•æ£€æµ‹è¿™ç§å½±å“ï¼Ÿ</h4><ul>
<li>å½±å“ï¼šå¦‚æœæ§ä»¶å¸¦æœ‰é€æ˜åº¦ï¼Œè¿™å°±ä¼šå¯¼è‡´å…¶æ§ä»¶ä¸ä¸‹å±‚çš„æ§ä»¶çš„é¢œè‰² æ··åˆåœ¨ä¸€å—ã€‚ä¾‹å¦‚ï¼Œä¸Šå±‚æ˜¯è“è‰²ï¼ˆé€æ˜åº¦50%ï¼‰ï¼Œä¸‹å±‚æ˜¯çº¢è‰²ï¼Œé‚£ä¹ˆæœ€ç»ˆæ˜¾ç¤ºçš„æ˜¯ç´«è‰²ã€‚<br>è¿™ç§é¢œè‰²çš„æ··åˆï¼Œéœ€è¦GPUå»å¤„ç†æ··åˆçš„ç»“æœï¼Œè¿™å°±ä¸€å®šç¨‹åº¦çš„é€ æˆGPUé¢å¤–çš„æ¶ˆè€—ã€‚å½“å®é™…å±‚æ¬¡æ›´åŠ å¤æ‚çš„æ—¶å€™ï¼ˆä¸‰å±‚ï¼Œäº”å±‚ï¼‰,GPUçš„æ¶ˆè€—æ›´åŠ æ˜æ˜¾ï¼Œå¯¹æ€§èƒ½çš„å½±å“å°±å¾ˆæ˜æ˜¾äº†ã€‚å¦‚æœå°†æœ€ä¸Šå±‚çš„é€æ˜åº¦è®¾ç½®ä¸º1ï¼Œè¿™æ ·GPUå°±ä¼šå¿½ç•¥è¯¥å±‚ä¸‹é¢æ‰€æœ‰å±‚æ¬¡ï¼ŒèŠ‚çº¦äº†ä¸å¿…è¦çš„è®¡ç®—ï¼Œä»è€Œæå‡æ€§èƒ½ã€‚</li>
<li>æ£€æµ‹ï¼šæ£€æµ‹æ­¥éª¤ï¼Œé€šè¿‡è‹¹æœè‡ªå¸¦çš„è½¯ä»¶instrumentsä¸­çš„core animation é€‰é¡¹ -&gt; é€‰æ‹©color Blended Layers é€‰é¡¹ çº¢è‰²åŒºåŸŸå°±æ˜¯é€æ˜åº¦çš„è®¾ç½®.</li>
<li>ä¼˜åŒ–æªæ–½ï¼š<ul>
<li>opaque = true å½“ç„¶è¿™ä¸ªUIViewé»˜è®¤å°±æ˜¯ trueçš„</li>
<li>alpha = 1 é€æ˜åº¦å°½é‡è®¾ç½®ä¸º1</li>
<li>æœ€é‡è¦çš„æ˜¯è¦è®¾ç½®èƒŒæ™¯é¢œè‰²ä¸çˆ¶ç±»ä¸€ç›´,å¦‚æœä¸è®¾ç½®é»˜è®¤ä¼šæ˜¯é€æ˜çš„ï¼Œå¦å¤–clearColorï¼ˆèƒŒæ™¯è‰²é€æ˜ï¼‰ä¹Ÿä¸èƒ½è®¾ç½®ï¼Œã€‚label.backgroundColor = UIColor.WhiteColor()</li>
</ul>
</li>
</ul>
<h4 id="4-ç¦»å±æ¸²æŸ“"><a href="#4-ç¦»å±æ¸²æŸ“" class="headerlink" title="4.ç¦»å±æ¸²æŸ“"></a>4.ç¦»å±æ¸²æŸ“</h4><p>ç¦»å±æ¸²æŸ“å°±æ˜¯ç›¸å¯¹äºæ­£å¸¸çš„æ¸²æŸ“æµç¨‹ï¼ˆå°†å›¾å±‚ç›´æ¥åˆæˆåˆ°å¸§çš„ç¼“å†²åŒºä¸­ï¼‰ï¼Œå¢åŠ äº†ä¸€ä¸ªé¢å¤–çš„æ­¥éª¤ï¼ˆå…ˆåˆ›å»ºå±å¹•å¤–ç¼“å†²åŒºï¼Œç„¶åæ¸²æŸ“åˆ°æ–‡ç†ä¸­ï¼Œæœ€åå°†ç»“æœæ¸²æŸ“åˆ°å¸§çš„ç¼“å†²åŒºï¼‰ï¼Œè¿™ä¸ªæ­¥éª¤ä¸­éœ€è¦GPUé¢å¤–çš„å¤„ç†è®¡ç®—ï¼Œé€ æˆå¾ˆå¤§æ¶ˆè€—ï¼Œæ‰€ä»¥ä¿—ç§°ï¼šç¦»å±æ¸²æŸ“ã€‚<br>æˆ‘ä»¬å…ˆçœ‹çœ‹æ­£å¸¸çš„æ¸²æŸ“é€šé“ï¼ˆRender-Passï¼‰ï¼š<br> <img src="../images/ç¬”è®°ä¸€/æ­£å¸¸æ¸²æŸ“.png" alt="" title="Title"><br>æ­£å¸¸çš„æ¸²æŸ“æ˜¯OpenGL æäº¤ä¸€ä¸ªå‘½ä»¤åˆ° command buff ï¼ŒéšåGPU è¿›è¡Œæ¸²æŸ“ ï¼Œç„¶åå°†æ¸²æŸ“ç»“æœåˆæˆåˆ°ï¼ˆrender buffï¼‰å¸§ç¼“å†²åŒºä¸­ã€‚<br>ä½†æ˜¯å¤æ‚çš„æ•ˆæœæ— æ³•ç›´æ¥æ¸²æŸ“å‡ºç»“æœï¼Œéœ€è¦åˆ†å¸ƒæ¸²æŸ“æœ€åç»„åˆèµ·æ¥ï¼Œæ¯”å¦‚æ·»åŠ ä¸€ä¸ªè’™ç‰ˆï¼ˆmaskï¼‰ï¼š<br><img src="../images/ç¬”è®°ä¸€/ç¦»å±æ¸²æŸ“.png" alt="" title="Title"><br>å¦‚å›¾æ‰€ç¤ºï¼Œæ¸²æŸ“æµç¨‹ä¸­ï¼Œåˆ†ä¸ºå¥½å‡ éƒ¨åˆ†è¿›è¡Œçš„ã€‚åœ¨å‰ä¸¤ä¸ªæ¸²æŸ“é€šé“ä¸­ï¼ŒGPUåˆ†åˆ«å¾—åˆ°çº¹ç†ï¼ˆtextureï¼Œä¹Ÿå°±æ˜¯ç›¸æœºå›¾æ ‡ï¼‰å’Œlayer(è“è‰²çš„è’™ç‰ˆ)çš„æ¸²æŸ“<br>ç»“æœã€‚ä½†è¿™ä¸¤ä¸ªæ¸²æŸ“ç»“æœæ²¡æœ‰ç›´æ¥æ”¾åˆ°render buffï¼ˆå¸§ç¼“å†²åŒºä¸­ï¼‰ï¼Œä¹Ÿå°±æ˜¯å‘ç”Ÿäº†ç¦»å±æ¸²æŸ“ï¼ŒçŸ¥é“ç¬¬ä¸‰ä¸ªæ¸²æŸ“é€šé“ï¼Œæ‰æŠŠä¸¤è€…ç»“åˆèµ·æ¥æ”¾å…¥ render buff ï¼ˆå¸§ç¼“å†²åŒºä¸­ï¼‰ã€‚ç¦»å±æ¸²æŸ“å®é™…ä¸Šå°±æ˜¯å°†æ¸²æŸ“ç»“æœä¸´æ—¶ä¿å­˜èµ·æ¥ï¼Œç­‰åˆ°ç”¨çš„æ—¶å€™å†å–å‡ºæ¥ï¼Œå› æ­¤ç›¸å¯¹äºæ™®é€šæ¸²æŸ“å ç”¨èµ„æºã€‚<br>ä»¥ä¸‹æƒ…å†µå¯èƒ½ä¼šå¯¼è‡´ç¦»å±æ¸²æŸ“:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.é‡å†™drawRect æ–¹æ³•ã€‚ï¼ˆä¸€èˆ¬æƒ…å†µä¸‹ç”»å›¾éƒ½ç”¨CAShapeLayerï¼‰</span><br><span class="line">2.æœ‰maskï¼ˆåœ†è§’ï¼‰æˆ–è€…é˜´å½±ï¼ˆlayer.masksToBoundsï¼Œlayer.shadowï¼‰ï¼Œæ¨¡ç³Šæ•ˆæœä¹Ÿæ˜¯ä¸€ç§mask (å½“ä½¿ç”¨åœ†è§’æˆ–è€…é˜´å½±æ˜¯æœ€å¥½å¼€å¯å…‰æ …åŒ–ä»¥è¾¾åˆ°ç¼“å†²çš„</span><br><span class="line">æ•ˆæœ)</span><br><span class="line">3.å…‰æ …åŒ– layer.shouldRasterize = true</span><br></pre></td></tr></table></figure>
<h4 id="3-å…‰æ …åŒ–"><a href="#3-å…‰æ …åŒ–" class="headerlink" title="3. å…‰æ …åŒ–"></a>3. å…‰æ …åŒ–</h4><p>æ‰€è°“å…‰æ …åŒ–å…¶å®å°±æ˜¯å°†ä¸€ä¸ªlayeré¢„å…ˆæ¸²æŸ“æˆä½å›¾(bitmap)ï¼Œç„¶ååŠ å…¥ç¼“å­˜ä¸­ã€‚å¦‚æœå¯¹äºé˜´å½±æ•ˆæœè¿™æ ·çš„æ¯”è¾ƒæ¶ˆè€—èµ„æºçš„é™æ€å†…å®¹è¿›è¡Œç¼“å­˜ã€<br>å¯ä»¥å¾—åˆ°ä¸€å®šå¹…åº¦çš„æ€§èƒ½æå‡ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">label.layer.shouldRasterize = <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>ç¼“å†²ä¸­çš„å¯¹è±¡æœ‰æ•ˆæœŸåªæœ‰100msï¼ˆ0ã€‚1sï¼‰å¦‚æœè¶…è¿‡è¿™ä¸ªæ—¶é—´ç¼“å­˜ä¼šè‡ªåŠ¨æ¸…ç†ã€‚å…‰æ …åŒ–æ˜¯æŠŠåŒåˆƒå‰‘ï¼Œå…ˆå†™å…¥ç¼“å­˜å†è¯»å–ä¼šæ¶ˆè€—ä¸€å®šçš„æ—¶é—´ï¼Œå› æ­¤åœ¨æ²¡æœ‰å¿…è¦çš„æƒ…å†µä¸‹å°½é‡ä¸è¦ä½¿ç”¨ã€‚é™¤éç¢°åˆ°å¾ˆå¤æ‚ã€é™æ€çš„æ•ˆæœæ‰èƒ½ä½¿ç”¨ã€‚ä¼šå¯¼è‡´ç¦»å±æ¸²æŸ“ã€‚</p>
<h3 id="4-å›¾ç‰‡å¤§å°"><a href="#4-å›¾ç‰‡å¤§å°" class="headerlink" title="4.å›¾ç‰‡å¤§å°"></a>4.å›¾ç‰‡å¤§å°</h3><p>å°½é‡ä¿æŒå›¾ç‰‡çš„å¤§å°åˆé€‚ï¼Œä»¥åŠå›¾ç‰‡çš„æ ¼å¼ GPUæ‰€æ”¯æŒã€‚å¦‚æœå›¾ç‰‡åå¤§åå°ï¼Œéƒ½éœ€è¦GPUé¢å¤–çš„å»è®¡ç®—å¤„ç†é€ æˆGPUçš„æ¶ˆè€—ï¼Œä»è€Œå¢åŠ å¤„ç†æ—¶é—´ã€‚<br>è€Œå›¾ç‰‡çš„æ ¼å¼å¦‚æœGPU ä¸æ”¯æŒçš„è¯åŒæ ·éœ€è¦GPUå»åšé¢å¤–çš„è½¬åŒ–ï¼Œæ¶ˆè€—å¤§é‡çš„æ—¶é—´ã€‚</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/è¯»ä¹¦ç¬”è®°/">è¯»ä¹¦ç¬”è®°</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-2015-07-08-Iterm2+ZSH-Shell" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/06/30/2015-07-08-Iterm2+ZSH-Shell/" class="article-date">
      <time datetime="2015-06-30T07:34:20.000Z" itemprop="datePublished">2015-06-30</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/30/2015-07-08-Iterm2+ZSH-Shell/">Iterm2+ZSH æ‰“é€ ç»ˆæShell</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
              Iterm2+ZSH æ‰“é€ ç»ˆæShell
          
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/å·¥å…·ç±»/">å·¥å…·ç±»</a></li></ul>
    </div>

      
        <p class="article-more-link">
          <a href="/2015/06/30/2015-07-08-Iterm2+ZSH-Shell/#more">more >></a>
        </p>
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-2015-06-30-iOS-9-AppThinning" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/06/30/2015-06-30-iOS-9-AppThinning/" class="article-date">
      <time datetime="2015-06-30T07:34:20.000Z" itemprop="datePublished">2015-06-30</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/30/2015-06-30-iOS-9-AppThinning/">iOS 9 App Thinning</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
              ios 9 æ–°æŠ€æœ¯
          
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ios-9-æ–°æŠ€æœ¯/">ios 9 æ–°æŠ€æœ¯</a></li></ul>
    </div>

      
        <p class="article-more-link">
          <a href="/2015/06/30/2015-06-30-iOS-9-AppThinning/#more">more >></a>
        </p>
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-2015-07-20-ReactiveCocoa" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/06/30/2015-07-20-ReactiveCocoa/" class="article-date">
      <time datetime="2015-06-30T07:34:20.000Z" itemprop="datePublished">2015-06-30</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/30/2015-07-20-ReactiveCocoa/">ReactiveCocoa å­¦ä¹ ä¹‹è·¯(å²ä¸Šæœ€å…¨æ”»ç•¥)</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
              ReactiveCocoa å­¦ä¹ ä¹‹è·¯
          
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ReactiveCocoa/">ReactiveCocoa</a></li></ul>
    </div>

      
        <p class="article-more-link">
          <a href="/2015/06/30/2015-07-20-ReactiveCocoa/#more">more >></a>
        </p>
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-2015-08-04-dependency-injection" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/06/30/2015-08-04-dependency-injection/" class="article-date">
      <time datetime="2015-06-30T07:34:20.000Z" itemprop="datePublished">2015-06-30</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/30/2015-08-04-dependency-injection/">å…³äºIOSä¾èµ–æ³¨å…¥(DI)é‚£äº›äº‹</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
              dependency injection
          
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dependency-injection/">dependency injection</a></li></ul>
    </div>

      
        <p class="article-more-link">
          <a href="/2015/06/30/2015-08-04-dependency-injection/#more">more >></a>
        </p>
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-2015-11-20-(BDD)calabashå’Œcucumber" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/06/30/2015-11-20-(BDD)calabashå’Œcucumber/" class="article-date">
      <time datetime="2015-06-30T07:34:20.000Z" itemprop="datePublished">2015-06-30</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/30/2015-11-20-(BDD)calabashå’Œcucumber/">BDDå¼€å‘ calabash å’Œ cucumberçš„ä½¿ç”¨</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
              Calabashæ˜¯ä¸€æ¬¾å¼€æºçš„è·¨å¹³å°UIæµ‹è¯•å·¥å…·ï¼Œç›®å‰æ”¯æŒiOSå’ŒAndroidã€‚
          
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/BDD/">BDD</a></li></ul>
    </div>

      
        <p class="article-more-link">
          <a href="/2015/06/30/2015-11-20-(BDD)calabashå’Œcucumber/#more">more >></a>
        </p>
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
</div>
      <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
<footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2016 RunningYoung
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="A fast, simple &amp; powerful blog framework">Hexo</a>  Theme <a href="https://github.com/RunningYoung/hexo-theme-yelee" target="_blank" title="Another simple and elegant theme for Hexo">Yelee</a> by runningyoung
            </div>
        </div>

        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" >Site Visitors: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit">Page Hits: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.1.22/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(https://runningyoung.github.io/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>


<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-64735170-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



<div class="scroll" id="scroll">
    <a href="#" title="Back to Top"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" title="Comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="Go to Bottom"><i class="fa fa-arrow-down"></i></a>
</div>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>